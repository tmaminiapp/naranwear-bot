

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NARAN</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://mapgl.2gis.com/api/js/v1"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    
   <style>
    :root {
        --bg: #ffffff;
        --dark: #000000;
        --gray: #8e8e93;
        --light: #f2f2f7;
        --accent: #000000;
        --red: #ff3b30;
    }

    /* ========== RESET & BASE ========== */
    * { 
        box-sizing: border-box; 
        -webkit-tap-highlight-color: transparent; 
        -webkit-touch-callout: none;
    }

    button, a, div[role="button"] {
        outline: none;
    }

    body { 
        margin: 0; 
        background: var(--bg); 
        font-family: 'Montserrat', sans-serif; 
        color: var(--dark); 
        overflow-x: hidden; 
    }

    [v-cloak] { display: none; }

    /* ========== HEADER & SEARCH ========== */
    .header { 
        background: #fff; 
        padding: 15px; 
        display: flex; 
        align-items: center; 
        justify-content: space-between; 
        position: sticky; 
        top: 0; 
        z-index: 100; 
        border-bottom: 1px solid #eeeeee;
    }

    .brand-name { 
        font-size: 22px; 
        font-weight: 800; 
        letter-spacing: 2px; 
        text-transform: uppercase; 
    }

    .search-container { 
        padding: 10px 15px; 
        background: #fff; 
        border-bottom: 1px solid #eee; 
    }

    .search-input { 
        width: 100%; 
        padding: 12px; 
        border: 1px solid #000; 
        border-radius: 2px; 
        font-family: inherit; 
        font-size: 14px; 
        text-transform: uppercase;
    }

    /* ========== LAYOUT & CONTAINERS ========== */
    .container { 
        padding: 15px; 
        padding-bottom: 100px; 
        min-height: 100vh; 
    }

    .admin-section { 
        background: #f9f9f9; 
        padding: 15px; 
        border-radius: 2px; 
        margin-top: 20px; 
        border: 1px solid #eee; 
    }

    .field { margin-bottom: 15px; }
    .field label { 
        display: block; 
        font-size: 10px; 
        font-weight: 800; 
        margin-bottom: 5px; 
        text-transform: uppercase; 
    }
    .input-admin { 
        width: 100%; 
        padding: 12px; 
        border: 1px solid #ddd; 
        font-family: inherit; 
        font-size: 13px; 
        border-radius: 2px; 
    }
    

    /* ========== CATEGORIES ========== */
    .cat-row { 
        display: flex; 
        gap: 10px; 
        margin-bottom: 20px; 
        overflow-x: auto; 
        padding: 5px 0; 
        scrollbar-width: none; 
    }
    .cat-row::-webkit-scrollbar { display: none; }

    .cat-tab {
        color: #000000;
        cursor: pointer;
        transition: all 0.1s ease;
        user-select: none;
        touch-action: manipulation;
    }

    .cat-tab:active {
        background: #000000;
        transform: scale(0.95);
        opacity: 0.7;
    }

    /* ========== PRODUCTS GRID ========== */
    .products-grid { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 15px; 
    }

    .card { 
        background: #fff; 
        border: 1px solid #f0f0f0; 
        position: relative; 
        overflow: hidden; 
    }

    /* ========== CARD SLIDER ========== */
    .slider-wrapper { 
        position: relative; 
        width: 100%; 
        aspect-ratio: 3/4; 
        overflow: hidden; 
        background: #f9f9f9; 
    }
    .slider-wrapper {
    touch-action: pan-y pinch-zoom; /* –£–ª—É—á—à–µ–Ω–Ω—ã–π touch */
}

.slider-inner {
    -webkit-overflow-scrolling: touch; /* –ü–ª–∞–≤–Ω—ã–π —Å–∫—Ä–æ–ª–ª –Ω–∞ iOS */
}

    .slider-inner { 
        display: flex; 
        overflow-x: auto; 
        scroll-snap-type: x mandatory; 
        scrollbar-width: none; 
        height: 100%; 
    }

    .slider-inner::-webkit-scrollbar { display: none; }
    
    .slider-inner img { 
        width: 100%; 
        height: 100%; 
        object-fit: cover; 
        scroll-snap-align: start; 
        flex-shrink: 0; 
    }

    .dots { 
        position: absolute; 
        bottom: 8px; 
        width: 100%; 
        display: flex; 
        justify-content: center; 
        gap: 4px; 
    }

    .dot { 
        width: 4px; 
        height: 4px; 
        border-radius: 50%; 
        background: rgba(0,0,0,0.2); 
    }

    .dot.active { 
        background: #000; 
        width: 10px; 
        border-radius: 2px; 
    }

    /* ========== CARD CONTENT ========== */
    .card-info { padding: 12px; }
    
    .card-title { 
        font-size: 11px; 
        font-weight: 600; 
        height: 28px; 
        overflow: hidden; 
        margin-bottom: 5px; 
        text-transform: uppercase; 
    }

   /* ========== PRICE STYLES ========== */
.price-row { 
    display: flex; 
    align-items: center; 
    gap: 8px; 
    margin-bottom: 10px;
    justify-content: flex-start;  /* –ü—Ä–∏–∂–∏–º–∞–µ—Ç –∫ –ª–µ–≤–æ–º—É –∫—Ä–∞—é */
    width: 100%;                  /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å—é —à–∏—Ä–∏–Ω—É */
    flex-wrap: wrap;             /* –ü–µ—Ä–µ–Ω–æ—Å –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –µ—Å–ª–∏ –Ω—É–∂–Ω–æ */
}

.price { 
    font-weight: 800; 
    font-size: 14px; 
    line-height: 1.2;           /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ —Å—Ç—Ä–æ–∫–∏ */
}

.old-price { 
    font-size: 11px; 
    color: var(--gray); 
    text-decoration: line-through;
    line-height: 1.2;           /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ —Å—Ç—Ä–æ–∫–∏ */
}

    .sale-badge { 
        background: #000; 
        color: #fff; 
        font-size: 9px; 
        padding: 2px 4px; 
        font-weight: 800; 
    }

    /* ========== SIZES ========== */
    .card-sizes { 
        display: flex; 
        gap: 5px; 
        overflow-x: auto; 
        padding: 5px 0; 
        scrollbar-width: none; 
        margin-bottom: 8px;
    }

    .size-chip { 
        font-size: 9px; 
        font-weight: 700; 
        padding: 4px 8px; 
        border: 1px solid #ddd; 
        color: #000;
        border-radius: 2px; 
        white-space: nowrap;
        cursor: pointer;
        outline: none;
    }

    .size-chip.active { 
        background-color: #000000; 
        color: #ffffff;
        border-color: #000000; 
    }

    .size-chip.disabled,
    .size-btn.disabled,
    .disabled,
    .disabled-size {
        opacity: 0.3;
        background: #eee;
        color: var(--gray);
        border-color: #d1d1d6;
        pointer-events: none;
        text-decoration: line-through;
        cursor: not-allowed;
    }

    .size-chip:active {
        transform: scale(0.92);
        transition: transform 0.1s;
    }

    .size-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        margin-bottom: 30px;
    }

    .size-btn { 
        flex: 1; 
        padding: 12px; 
        border: 1px solid #eee; 
        background: #fff; 
        color: #000; 
        font-size: 12px; 
        font-weight: 700; 
        border-radius: 2px; 
        cursor: pointer;
    }

    .size-btn.active { 
        border-color: #000; 
        background: #000; 
        color: #fff; 
    }

    .size-btn:active {
        transform: scale(0.95);
        transition: transform 0.1s;
    }

    /* ========== BUTTONS ========== */
    .btn-row { 
        display: flex; 
        gap: 8px; 
        margin-top: 10px;
        align-items: flex-end; 
    }

    .btn-black { 
        background: #000; 
        color: #fff; 
        border: none; 
        height: 50px; 
        flex: 1; 
        font-weight: 700; 
        font-size: 11px; 
        text-transform: uppercase; 
        cursor: pointer; 
        border-radius: 2px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }

    .btn-fav { 
        background: #fff; 
        border: 1px solid #000; 
        width: 50px;  
        height: 50px; 
        box-sizing: border-box;
        display: flex; 
        align-items: center; 
        justify-content: center; 
        padding: 0;   
        flex-shrink: 0;
        border-radius: 2px;
    }

    .btn-fav svg {
        width: 24px; 
        height: 24px;
        display: block;
        stroke: #000;
    }

    /* ========== FAVORITES ========== */
    .fav-overlay { 
        position: absolute; 
        top: 8px; 
        right: 8px; 
        z-index: 10; 
        background: rgba(255,255,255,0.7); 
        border-radius: 50%; 
        width: 30px; 
        height: 30px; 
        display: flex; 
        align-items: center; 
        justify-content: center;
        border: none; 
        cursor: pointer; 
        backdrop-filter: blur(2px);
    }

    /* ========== MODAL WINDOWS ========== */
    .modal { 
        position: fixed; 
        inset: 0; 
        background: #fff; 
        z-index: 2000; 
        overflow-y: auto; 
        padding-bottom: 50px; 
    }

    .close-modal {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 2100;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        color: #000;
        border: 1px solid rgba(0, 0, 0, 0.1);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 400;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        outline: none;
    }

    .close-modal:hover {
        background: rgba(255, 255, 255, 0.95);
        transform: scale(1.05);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
    }

    .close-modal:active {
        transform: scale(0.95);
        background: rgba(255, 255, 255, 0.85);
    }

    /* ========== ANIMATIONS ========== */
    @keyframes modalFadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes modalFadeOut {
        from { opacity: 1; }
        to { opacity: 0; visibility: hidden; }
    }

    .modal {
        animation: modalFadeIn 0.3s ease;
    }

    .modal.fade-out {
        animation: modalFadeOut 0.2s ease forwards;
    }

    /* ========== CART ========== */
    .cart-item { 
        display: flex; 
        gap: 15px; 
        padding: 15px 0; 
        border-bottom: 1px solid #eee; 
    }

    .cart-img { 
        width: 80px; 
        aspect-ratio: 3/4; 
        object-fit: cover; 
    }

    .qty-controls { 
        display: flex; 
        align-items: center; 
        gap: 15px; 
        margin-top: 10px; 
    }

    .qty-btn { 
        width: 25px; 
        height: 25px; 
        border: 1px solid #000; 
        background: none; 
        font-weight: 800; 
    }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
.loader-mini {
    width: 20px;
    height: 20px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #000;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* –ü–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ */
.preview-card {
    transition: all 0.3s ease;
}

.preview-card:hover {
    transform: scale(1.05);
}

    /* ========== DELIVERY ========== */
    #map { 
        width: 100%; 
        height: 300px; 
        background: #f0f0f0; 
        margin: 15px 0; 
        border: 1px solid #000; 
    }

    .delivery-grid { 
        display: grid; 
        grid-template-columns: 1fr 1fr 1fr; 
        gap: 8px; 
        margin: 15px 0; 
    }

    /* ========== ORDERS ========== */
    .order-card { 
        background: #fff; 
        border: 1px solid #eee; 
        padding: 15px; 
        margin-bottom: 10px; 
        color: #000; 
    }

    .status-badge { 
        display: inline-block; 
        padding: 4px 8px; 
        font-size: 9px; 
        font-weight: 800; 
        text-transform: uppercase; 
        margin-top: 5px; 
    }

    .status-ready { 
        background: #e8f5e9; 
        color: #2e7d32; 
    }

    .status-process { 
        background: #fff3e0; 
        color: #ef6c00; 
    }
    /* –í –±–ª–æ–∫–µ —Å—Ç–∏–ª–µ–π –¥–æ–±–∞–≤—å—Ç–µ –∏–ª–∏ –∑–∞–º–µ–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ */

.control-buttons-compact {
    display: flex;
    flex-direction: column;
    gap: 8px;
    align-items: center;
    justify-content: center;
    padding-left: 15px;
    border-left: 1px solid #eee;
    min-width: 55px !important; /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É */
    margin-left: 10px; /* –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø —Å–ª–µ–≤–∞ */
}

.control-btn-compact {
    width: 45px !important; /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∫–Ω–æ–ø–æ–∫ */
    height: 45px !important;
    border: none;
    background: #ececec;
    border-radius: 10px !important; /* –ë–æ–ª–µ–µ —Å–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã */
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 18px !important; /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏–∫–æ–Ω–∫–∏ */
    color: #000 !important; /* –î–µ–ª–∞–µ–º –∏–∫–æ–Ω–∫–∏ —á–µ—Ä–Ω—ã–º–∏ –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ */
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* –õ–µ–≥–∫–∞—è —Ç–µ–Ω—å –¥–ª—è –æ–±—ä–µ–º–∞ */
}

.control-btn-compact:active {
    transform: scale(0.95);
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}
.image-loading {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
}
/* –°–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏ —Ñ–∞–π–ª–æ–≤ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
@media (max-width: 768px) {
    .file-info-desktop {
        display: none !important;
    }
}

/* –ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
@media (min-width: 769px) {
    .file-info-desktop {
        display: block !important;
    }
}
/* –ú–æ–±–∏–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
@media (max-width: 768px) {
    .product-image {
        height: auto;
        min-height: 200px;
        object-fit: cover;
    }
    
    /* –£–ª—É—á—à–µ–Ω–∏–µ –∫–∞—Å–∞–Ω–∏–π */
    .slider-inner img {
        touch-action: manipulation;
    }
    
    /* –£–ª—É—á—à–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ */
    .image-loading-placeholder {
        aspect-ratio: 3/4;
        background: #f5f5f5;
    }
}

@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}
@media (max-width: 480px) {
    .preview-card {
        width: 50px;
        height: 50px; /* –ú–µ–Ω—å—à–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    }
    
    .remove-preview-btn {
        width: 16px;
        height: 16px;
        font-size: 10px;
    }
}
/* –£–ª—É—á—à–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
@media (max-width: 480px) {
    .control-buttons-compact {
        min-width: 50px !important;
        padding-left: 10px;
        margin-left: 8px;
    }
    
    .control-btn-compact {
        width: 40px !important;
        height: 40px !important;
        font-size: 16px !important;
    }
}

    /* ========== BOTTOM NAVIGATION ========== */
    .bottom-nav { 
        position: fixed; 
        bottom: 0; 
        left: 0; 
        right: 0; 
        background: #fff; 
        display: flex; 
        justify-content: space-around; 
        padding: 10px 0 25px; 
        border-top: 1px solid #eee; 
        z-index: 1000; 
    }

    .nav-item { 
        border: none; 
        background: none; 
        color: #a1a1a1; 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        font-size: 9px; 
        font-weight: 700; 
        gap: 4px; 
        text-transform: uppercase; 
        position: relative;
    }

    .nav-item.active { color: #000; }
    
    .nav-item svg { 
        width: 20px; 
        height: 20px; 
    }

    .badge { 
        position: absolute; 
        top: -5px; 
        right: -8px; 
        background: var(--red); 
        color: #fff; 
        font-size: 9px; 
        padding: 2px 5px; 
        border-radius: 10px; 
        font-weight: 800;
    }

    /* ========== PREVIEW IMAGES ========== */
    .preview-container {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
        margin: 10px 0;
    }

    .preview-card {
        position: relative;
        width: 60px;
        height: 60px;
    }

    .preview-card img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 6px;
        border: 1px solid #ddd;
    }

    .remove-preview-btn {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #ff3b30;
        color: white;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        border: 1px solid white;
        cursor: pointer;
    }

    /* ========== UTILITY CLASSES ========== */
    .stable-list {
        height: 500px;
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
        contain: layout;
    }

    .fixed-item {
        transition: none;
        animation: none;
        will-change: auto;
    }

    .description-container {
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .description-container.collapsed {
        max-height: 60px;
    }

    .description-container.expanded {
        max-height: 500px;
    }
@media (max-width: 480px) {
    .close-modal {
        top: 10px;
        right: 10px;
        width: 35px;
        height: 35px;
        font-size: 16px;
    }
}
    /* ========== MEDIA QUERIES ========== */
   @media (max-width: 480px) {
    .products-grid {
        grid-template-columns: 1fr 1fr; /* 2 –∫–æ–ª–æ–Ω–∫–∏ –¥–∞–∂–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        gap: 10px;
    }
    
    .card {
        border-radius: 8px; /* –ë–æ–ª–µ–µ –º—è–≥–∫–∏–µ —É–≥–ª—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    }
}
</style>
</head>
<body>

<div id="app" v-cloak>
    
    <header class="header">
        <button @click="burgerOpen = !burgerOpen; vib()" style="border:none; background:none;">
            <svg viewBox="0 0 24 24" width="24" height="24" stroke="#000000" stroke-width="2" fill="none"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </button>
        <div class="brand-name">NARAN</div>
        <div class="header-side" style="justify-content: flex-end;">
        <button v-if="tab === 'catalog'" @click="searchMode = !searchMode; vib()" style="border:none; background:none; padding:0;">
            <svg viewBox="0 0 24 24" width="22" height="22" stroke="#000000" stroke-width="2.5" fill="none"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        </button>
    </div>
    </header>

    <div v-if="searchMode && tab === 'catalog'" class="search-container">
    <input v-model="searchQuery" class="search-input" placeholder="–ü–û–ò–°–ö –¢–û–í–ê–†–ê..." @input="vib()">
</div>

    <div v-if="burgerOpen" class="modal" style="padding: 40px; z-index: 3000; overflow-y: auto;">
    <button class="close-modal" @click="burgerOpen = false">‚úï</button>
    <div class="brand-name" style="margin-bottom: 40px;">NARAN</div>
    
    <div style="display: flex; flex-direction: column; gap: 10px;">
        
        <div class="menu-accordion">
            <div class="menu-item" @click="activeInfo = activeInfo === 'about' ? null : 'about'; haptic()" 
                 style="display: flex; justify-content: space-between; font-weight: 700; padding: 15px 0; border-bottom: 1px solid #eee;">
                <span>–û –ù–ê–°</span>
                <span>{{ activeInfo === 'about' ? '‚àí' : '+' }}</span>
            </div>
            <div v-if="activeInfo === 'about'" style="padding: 15px 0; font-size: 13px; line-height: 1.6; color: #666; animation: fadeIn 0.3s ease;">
                –¢–æ–≤–∞—Ä –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –Ω–∞ —Ñ–∞–±—Ä–∏–∫–∞—Ö –¢—É—Ä—Ü–∏–∏ –∏ –ö–∏—Ç–∞—è. –ö–∞—á–µ—Å—Ç–≤–æ LUXE, –Ω–µ –ø—É—Ç–∞–π—Ç–µ —Å –¥–µ—à–µ–≤—ã–º –ø–µ—Ä–µ—à–∏–≤–æ–º.–í—Å–µ —Ñ–æ—Ç–æ –≤ –≥—Ä—É–ø–ø–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ: –ª–∏–±–æ –Ω–∞ –Ω–∞—à–µ–π –¥–µ–≤–æ—á–∫–µ-–º–æ–¥–µ–ª–∏, –ª–∏–±–æ —Å —Ñ–∞–±—Ä–∏–∫. –û–¥–µ–∂–¥–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∑–∞—è–≤–ª–µ–Ω–Ω—ã–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º –∏ –±–æ–ª–µ–µ —á–µ–º –æ–ø—Ä–∞–≤–¥—ã–≤–∞–µ—Ç –∫–∞–∂–¥—É—é –∫–æ–ø–µ–π–∫—É. –¶–µ–Ω—ã –≤ –≥—Ä—É–ø–ø–µ —É–∫–∞–∑–∞–Ω—ã –æ–ø—Ç–æ–≤—ã–µ –¥–ª—è –≤—Å–µ—Ö –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π.–ü—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è –±—Ä–æ–Ω–∏ –ø–æ 100% –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–µ
            </div>
        </div>

        <div class="menu-accordion">
            <div class="menu-item" @click="activeInfo = activeInfo === 'delivery' ? null : 'delivery'; haptic()" 
                 style="display: flex; justify-content: space-between; font-weight: 700; padding: 15px 0; border-bottom: 1px solid #eee;">
                <span>–î–û–°–¢–ê–í–ö–ê</span>
                <span>{{ activeInfo === 'delivery' ? '‚àí' : '+' }}</span>
            </div>
            <div v-if="activeInfo === 'delivery'" style="padding: 15px 0; font-size: 13px; line-height: 1.6; color: #666; animation: fadeIn 0.3s ease;">
                –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –æ–ø–ª–∞—á–∏–≤–∞—é—Ç—Å—è –∑–∞–∫–∞–∑—á–∏–∫–æ–º. –°—Ç–æ–∏–º–æ—Å—Ç—å –∏ —Å—Ä–æ–∫ –¥–æ—Å—Ç–∞–≤–∫–∏ –ø–æ—Å—ã–ª–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç–µ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ, —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤—É—è—Å—å —Ç–∞—Ä–∏—Ñ–∞–º–∏ –ø–æ—á—Ç—ã –∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π, –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞ –∏—Ö –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∞–π—Ç–∞—Ö. –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∞–≤—Ç–æ–±—É—Å–æ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏—Ç–µ –µ–≥–æ –Ω–æ–º–µ—Ä, –≥–æ—Ä–æ–¥, —Å—Ç–æ—è–Ω–∫—É –∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤–æ–¥–∏—Ç–µ–ª—è. 
            </div>
        </div>

        <div class="menu-accordion">
            <div class="menu-item" @click="activeInfo = activeInfo === 'return' ? null : 'return'; haptic()" 
                 style="display: flex; justify-content: space-between; font-weight: 700; padding: 15px 0; border-bottom: 1px solid #eee;">
                <span>–í–û–ó–í–†–ê–¢</span>
                <span>{{ activeInfo === 'return' ? '‚àí' : '+' }}</span>
            </div>
            <div v-if="activeInfo === 'return'" style="padding: 15px 0; font-size: 13px; line-height: 1.6; color: #666; animation: fadeIn 0.3s ease;">
                –ü—Ä–∏ —Å–∞–º–æ–≤—ã–≤–æ–∑–µ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤ –∏ –æ–±–º–µ–Ω–æ–≤ –ù–ï–¢! –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Ç–æ–≤–∞—Ä –Ω–∞ –±—Ä–∞–∫ –Ω–∞ –º–µ—Å—Ç–µ –∏–ª–∏ –ø—Ä–æ—Å–∏—Ç–µ –ø–æ—Å—Ä–µ–¥–Ω–∏–∫–æ–≤. –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ, –ø–æ–ª—É—á–∞—è —Ç–æ–≤–∞—Ä —Å–Ω–∏–º–∞–π—Ç–µ —Ä–∞—Å–ø–∞–∫–æ–≤–∫—É –Ω–∞ –≤–∏–¥–µ–æ. –í —Å–ª—É—á–∞–µ –±—Ä–∞–∫–∞ —Ä–µ—à–∏–º –ø—Ä–æ–±–ª–µ–º—É! –¢–æ–ª—å–∫–æ –ø–∏—à–∏—Ç–µ —Å—Ä–∞–∑—É, 1-2 –¥–Ω—è —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∏—è.
            </div>
        </div>

        <div class="menu-accordion">
            <div class="menu-item" @click="activeInfo = activeInfo === 'address' ? null : 'address'; haptic()" 
                 style="display: flex; justify-content: space-between; font-weight: 700; padding: 15px 0; border-bottom: 1px solid #eee;">
                <span>–ù–ê–® –ê–î–†–ï–°</span>
                <span>{{ activeInfo === 'address' ? '‚àí' : '+' }}</span>
            </div>
            <div v-if="activeInfo === 'address'" style="padding: 15px 0; font-size: 13px; line-height: 1.6; color: #666; animation: fadeIn 0.3s ease;">
                –≥. –ú–æ—Å–∫–≤–∞, 14 –∫–º. –ú–ö–ê–î, –¢–¶ –°–∞–¥–æ–≤–æ–¥, –º–µ—Å—Ç–æ 2–í-73 –∫–æ—Ä–ø—É—Å –ë. –ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã: –µ–∂–µ–¥–Ω–µ–≤–Ω–æ —Å 8:00 –¥–æ 18:00
            </div>
        </div>

    </div>
</div>

    <main class="container">
    <div v-if="tab === 'catalog'">
        <div class="cat-row">
            <button @click="setCategory('')" :class="['cat-tab', currentCat === '' ? 'active' : '']">–í–°–ï –¢–û–í–ê–†–´</button>
            <button v-for="cat in categories" :key="cat.id" @click="setCategory(cat.name)" :class="['cat-tab', currentCat === cat.name ? 'active' : '']">
                {{cat.name}}
            </button>
        </div>

       <div class="products-grid">
    <div v-for="p in filteredProducts" :key="p.id" class="card">
        <div class="slider-wrapper">
            <button class="fav-overlay" @click.stop="toggleFav(p)">
                <svg :fill="isFav(p) ? '#ff3b30' : 'none'" viewBox="0 0 24 24" width="20" height="20" :stroke="isFav(p) ? '#ff3b30' : '#000'" stroke-width="2">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
            </button>

       <div class="slider-inner" 
                     @scroll="e => handleScroll(e, p)" 
                     @click="openProduct(p)">
                    <img v-for="(img, idx) in getProductImages(p)" 
                         :key="idx" 
                         :src="img" 
                         :alt="'–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ' + (idx + 1)"
                         loading="lazy"
                         decoding="async"
                         @error="handleImageError"
                         class="product-image">
                </div>
    <div class="dots" v-if="getProductImages(p).length > 1">
                    <span v-for="(img, i) in getProductImages(p)" 
                          :key="i" 
                          :class="['dot', {active: i === (p.aIdx || 0)}]"></span>
    </div>
            <div v-if="p.oldPrice" class="sale-badge" style="position:absolute; top:10px; left:10px;">SALE</div>
            <div v-if="p.isNew" class="new-badge" :style="{ position: 'absolute', top: p.oldPrice ? '35px' : '10px', left: '10px', background: '#000', color: '#fff', fontSize: '10px', fontWeight: '800', padding: '4px 8px', borderRadius: '4px', zIndex: 5 }">NEW</div>

<div v-if="p.variants && getVisibleVariants(p).length > 1" 
             style="position: absolute; bottom: 8px; right: 8px; display: flex; gap: 4px; z-index: 10;">
            <div v-for="(v, vIdx) in getVisibleVariants(p)" 
                 :key="vIdx"
                 @click.stop="selectVisibleColor(p, v)"
                 :style="{
                     width: '12px',
                     height: '12px',
                     borderRadius: '50%',
                     border: '2px solid white',
                     background: getActiveColorIndex(p) === vIdx ? '#000' : '#ccc',
                     cursor: 'pointer',
                     boxShadow: '0 2px 4px rgba(0,0,0,0.3)'
                 }"
                 :title="v.color">
            </div>
        </div>
        </div>

       <div class="card-info">
      <div class="card-title" @click="openProduct(p)" style="font-size: 10px; font-weight: 600; height: auto; min-height: 10px; margin-bottom: 4px; line-height: 1.3;">
        {{p.title}}
    </div>
        <div class="price-row" @click="openProduct(p)">
            <span class="price">{{p.price}} ‚ÇΩ</span>
            <span v-if="p.oldPrice" class="old-price">{{p.oldPrice}} ‚ÇΩ</span>
        </div>
        
        <!-- –†–ê–ó–ú–ï–†–´ –î–õ–Ø –ê–ö–¢–ò–í–ù–û–ì–û –¶–í–ï–¢–ê -->
        <div class="card-sizes" v-if="p.variants && getVisibleVariants(p).length > 0">
            <div v-for="(qty, sz) in (getVisibleVariants(p)[getActiveColorIndex(p)]?.stocks || {})" 
                 :key="sz"
                 @click.stop="qty > 0 ? (p.tempSize = sz, vib()) : null"
                 :class="['size-chip', {
                    active: p.tempSize === sz,
                    disabled: qty <= 0
                 }]">
                {{ sz }}
            </div>
        </div>
        
        <button class="btn-black" style="width: 100%;" @click.stop="quickAddToCart(p)">
            –í –ö–û–†–ó–ò–ù–£
        </button>
    </div>
</div>
</div>
        <div v-if="filteredProducts.length === 0" style="text-align:center; padding: 50px; font-weight: 700;">–¢–û–í–ê–†–û–í –ù–ï –ù–ê–ô–î–ï–ù–û</div>
    </div>

  <div v-if="tab === 'favs'">
    <h2 class="brand-name" style="font-size: 16px; margin-bottom: 20px;">–ò–ó–ë–†–ê–ù–ù–û–ï</h2>
    
    <div v-if="favList.length === 0" style="text-align:center; padding: 50px; color: #999;">
        –ó–¥–µ—Å—å –ø–æ–∫–∞ –ø—É—Å—Ç–æ
    </div>
    
    <!-- –¢–æ—Ç –∂–µ —Å–∞–º—ã–π products-grid –∫–∞–∫ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ -->
    <div class="products-grid">
        <div v-for="p in favList" :key="p.id" class="card">
            <div class="slider-wrapper">
                <button class="fav-overlay" @click.stop="toggleFav(p)">
                    <svg :fill="isFav(p) ? '#ff3b30' : 'none'" viewBox="0 0 24 24" width="20" height="20" :stroke="isFav(p) ? '#ff3b30' : '#000'" stroke-width="2">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                    </svg>
                </button>

      <div class="slider-inner" 
     @scroll="e => handleScroll(e, p)" 
     @click="openProduct(p)">
    <img v-for="(img, idx) in getProductImages(p)" 
         :key="idx" 
         :src="img" 
         :alt="'–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ' + (idx + 1)"
         loading="lazy"
         decoding="async"
         @error="handleImageError"
         class="product-image">
</div>
<div class="dots" v-if="getProductImages(p).length > 1">
    <span v-for="(img, i) in getProductImages(p)" 
          :key="i" 
          :class="['dot', {active: i === (p.aIdx || 0)}]"></span>
</div>

                <div v-if="p.oldPrice" class="sale-badge" style="position:absolute; top:10px; left:10px;">SALE</div>
                <div v-if="p.isNew" class="new-badge" :style="{ position: 'absolute', top: p.oldPrice ? '35px' : '10px', left: '10px', background: '#000', color: '#fff', fontSize: '10px', fontWeight: '800', padding: '4px 8px', borderRadius: '4px', zIndex: 5 }">NEW</div>
            </div>

            <div class="card-info">
                <div class="card-title" @click="openProduct(p)" style="font-size: 10px; font-weight: 600; height: auto; min-height: 10px; margin-bottom: 4px; line-height: 1.3;">
        {{p.title}}
    </div>
        <div class="price-row" @click="openProduct(p)">
            <span class="price">{{p.price}} ‚ÇΩ</span>
            <span v-if="p.oldPrice" class="old-price">{{p.oldPrice}} ‚ÇΩ</span>
        </div>
                
             <!-- –í —Ä–∞–∑–¥–µ–ª–µ favs –ó–ê–ú–ï–ù–ò–¢–ï -->
<div class="card-sizes" v-if="p.variants && getVisibleVariants(p).length > 0">
    <!-- –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –í–ò–î–ò–ú–´–ô –≤–∞—Ä–∏–∞–Ω—Ç -->
    <div v-for="(qty, sz) in (getVisibleVariants(p)[getActiveColorIndex(p)]?.stocks || {})" 
         :key="sz"
         @click.stop="qty > 0 ? (p.tempSize = sz, vib()) : null"
         :class="['size-chip', {
            active: p.tempSize === sz,
            disabled: qty <= 0
         }]">
        {{ sz }}
    </div>
</div>
                
                <button class="btn-black" style="width: 100%;" @click.stop="quickAddToCart(p)">
                    –í –ö–û–†–ó–ò–ù–£
                </button>
            </div>
        </div>
    </div>
</div>
                
                <div v-if="tab === 'cart'">
        <h2 class="brand-name" style="font-size: 16px; margin-bottom: 20px;">–ö–û–†–ó–ò–ù–ê</h2>
<div v-if="cart.length === 0" style="text-align:center; padding: 50px;">–í–ê–®–ê –ö–û–†–ó–ò–ù–ê –ü–£–°–¢–ê</div>
<div v-else>
  <div v-for="item in cart" :key="item.cartId" class="cart-item">
    
    <img :src="item.img || item.image || ''" 
     class="cart-img" 
     @click="openProductFromCart(item)" 
     style="cursor:pointer; width: 70px; height: 90px; object-fit: cover; border-radius: 8px;">
     
    <div style="flex:1; margin-left: 12px;">
        <div @click="openProduct(item)" style="cursor:pointer;">
            <div style="font-weight:700; font-size:12px; text-transform:uppercase; letter-spacing: 0.5px;">
                {{item.title}}
            </div>
            
            <div style="font-size:10px; color:gray; margin: 4px 0; font-weight: 600;">
                –†–ê–ó–ú–ï–†: {{item.selSize}} | –¶–í–ï–¢: {{item.selColor}}
            </div>
            
            <div style="font-weight:800; font-size: 14px;">{{item.price}} ‚ÇΩ</div>
        </div>

        <div class="qty-controls" style="display: flex; align-items: center; gap: 12px; margin-top: 8px;">
            <button class="qty-btn" @click="changeQty(item, -1)" 
                    style="width: 28px; height: 28px; border: 1px solid #eee; background: #fff; border-radius: 4px;">-</button>
            
            <span style="font-weight:700; font-size: 13px;">{{item.qty}}</span>
            
            <button class="qty-btn" @click="changeQty(item, 1)"
                    style="width: 28px; height: 28px; border: 1px solid #eee; background: #fff; border-radius: 4px;">+</button>
        </div>
    </div>
    
    <button @click="removeFromCart(item.cartId)" 
            style="background: none; border: none; color: #ccc; padding: 5px; font-size: 18px;">‚úï</button>
</div>

    <div style="margin-top: 30px;">
        <div class="field">
            <label>–í–ê–®–ï –ò–ú–Ø</label>
            <input v-model="form.name" class="input-admin" placeholder="–ò–ú–Ø">
        </div>
        <div class="field">
            <label>–¢–ï–õ–ï–§–û–ù (10-11 –¶–ò–§–†)</label>
            <input v-model="form.phone" class="input-admin" type="tel" placeholder="89000000000">
        </div>

        <label style="font-size:10px; font-weight:800;">–°–ü–û–°–û–ë –î–û–°–¢–ê–í–ö–ò</label>
        <div class="delivery-grid">
            <button v-for="d in ['–°–î–≠–ö', '–ü–û–ß–¢–ê', '5POST']" :key="d" @click="setDelivery(d)" :class="['cat-tab', {active: deliv === d}]">{{d}}</button>
        </div>

        <div id="map" v-show="deliv"></div>
        <div v-if="address" style="font-size:12px; font-weight:700; margin-bottom: 20px;">üìç {{address}}</div>
     <div class="field" style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 8px;">
    
    <div style="font-size: 9px; color: #999;"></div>
</div>

<!-- –ù–∞–π–¥–∏—Ç–µ —ç—Ç–æ—Ç –±–ª–æ–∫ –≤ cart –∏ –ó–ê–ú–ï–ù–ò–¢–ï: -->
<div style="margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 2px; border: 1px solid #eee;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <span style="font-size: 13px; font-weight: 800;">–ò–¢–û–ì–û –ö –û–ü–õ–ê–¢–ï:</span>
        <span style="font-size: 18px; font-weight: 800;">{{ total() }} ‚ÇΩ</span>
    </div>
</div>

        <div style="font-size: 9px; color: var(--gray); line-height: 1.2; margin-bottom: 15px; text-align: center;">
            –ù–∞–∂–∏–º–∞—è –Ω–∞ –∫–Ω–æ–ø–∫—É, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏ –∑–∞–∫–∞–∑–∞ –∏ –¥–∞–µ—Ç–µ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å 152-–§3 –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∏ –¥–æ—Å—Ç–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞.
        </div>

        <button class="btn-black" style="width:100%; height:60px; font-size: 14px;" @click="checkout">
            –û–§–û–†–ú–ò–¢–¨ –ó–ê–ö–ê–ó
        </button>
    </div>
</div> </div>   <div v-if="tab === 'profile'">
    <div style="text-align:center; margin-bottom: 30px;">
        <img :src="user.photo_url || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'" style="width:80px; height:80px; border-radius:50%; border: 1px solid #000; padding: 3px;">
         <div style="font-weight:800; margin-top:10px; text-transform:uppercase;">
            {{ isAdmin ? '–ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†' : (user.first_name || '–ö–ª–∏–µ–Ω—Ç') }}
        </div>

        
         <button 
            v-if="!isAdmin"
            @click="openSupport" 
            class="cat-tab" 
            style="margin-top:15px; width:100%;">
            –ù–ê–ü–ò–°–ê–¢–¨ –í –ü–û–î–î–ï–†–ñ–ö–£
        </button>
    </div>

    <div v-if="!isAdmin">
        <h3 class="brand-name" style="font-size: 14px; margin-bottom: 15px;">–ú–û–ò –ó–ê–ö–ê–ó–´</h3>
        
        <div v-if="myOrders.length === 0" style="padding:20px; text-align:center; font-size:12px; color: var(--gray);">
            –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤
        </div>

        <div v-for="o in myOrders" :key="o.id" class="order-card" style="background: var(--light); padding: 15px; border-radius: 12px; margin-bottom: 10px;">
            <div style="display:flex; justify-content:space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-weight:800; font-size:12px; letter-spacing: 0.5px;">–ó–ê–ö–ê–ó ‚Ññ{{o.order_id}}</span>
                <span style="font-weight:800; font-size:14px;">{{ o.order_total || o.total }} ‚ÇΩ</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div :class="['status-badge', o.status === '–î–æ—Å—Ç–∞–≤–ª–µ–Ω' ? 'status-ready' : 'status-process']" style="font-size: 10px; margin-top: 0;">
                    {{o.status || '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ'}}
                </div>
                <div style="font-size:10px; color:gray; font-weight: 600;">{{o.date}}</div>
            </div>
        </div>
    </div> 
    
    <div v-if="isAdmin" class="admin-section">
        <h2 class="brand-name" style="font-size: 14px; margin-bottom: 20px;">–ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨</h2>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px;">
             <div style="background: var(--light); color: var(--dark); padding: 16px; border-radius: 15px;">
                <div style="font-size: 9px; font-weight: 800; opacity: 0.6; letter-spacing: 1px; margin-bottom: 5px;">–°–ï–ì–û–î–ù–Ø</div>
                <div style="font-size: 18px; font-weight: 800;">{{ stats.todayRev.toLocaleString() }} ‚ÇΩ</div>
                <div style="font-size: 10px; opacity: 0.8;">{{ stats.todayCount }} –∑–∞–∫.</div>
             </div>
             <div style="background: var(--light); color: var(--dark); padding: 16px; border-radius: 15px;">
                <div style="font-size: 9px; font-weight: 800; color: var(--gray); letter-spacing: 1px; margin-bottom: 5px;">–ú–ï–°–Ø–¶</div>
                <div style="font-size: 18px; font-weight: 800;">{{ stats.monthRev.toLocaleString() }} ‚ÇΩ</div>
                <div style="font-size: 10px; color: var(--gray);">{{ stats.monthCount }} –∑–∞–∫.</div>
             </div>
             <div style="grid-column: span 2; background: #fff; padding: 16px; border-radius: 15px; border: 1px solid var(--light); display: flex; justify-content: space-between; align-items: center;">
                 <div>
                    <div style="font-size: 9px; font-weight: 800; color: var(--gray); letter-spacing: 1px;">–û–ë–©–ê–Ø –í–´–†–£–ß–ö–ê</div>
                    <div style="font-size: 20px; font-weight: 800;">{{ stats.allRev.toLocaleString() }} ‚ÇΩ</div>
                 </div>
                 <div style="text-align: right;">
                    <div style="font-size: 9px; font-weight: 800; color: var(--gray); letter-spacing: 1px;">–í–°–ï–ì–û –ó–ê–ö–ê–ó–û–í</div>
                    <div style="font-size: 20px; font-weight: 800;">{{ stats.allCount }}</div>
                 </div>
             </div>
        </div>

        <div style="background: #fff; padding: 15px; border-radius: 20px; border: 1px solid #eee; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.03);">
             <div style="font-size: 10px; font-weight: 800; color: var(--gray); letter-spacing: 1px; margin-bottom: 15px;">–î–ò–ù–ê–ú–ò–ö–ê –ó–ê–ö–ê–ó–û–í (7 –î–ù–ï–ô)</div>
            <canvas id="orderChart" style="max-height: 200px;"></canvas>
        </div>
        
       <div class="field">
    <label>–î–û–ë–ê–í–ò–¢–¨ –ö–ê–¢–ï–ì–û–†–ò–Æ</label>
    <div style="display:flex; gap:10px;">
        <input v-model="newCat" class="input-admin" placeholder="–ù–ê–ó–í–ê–ù–ò–ï">
        <button class="btn-black" @click="manageCategory('add')" style="padding: 10px;">+</button>
    </div>
    <div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:10px;">
        <span v-for="c in categories" :key="c.id" class="sale-badge" @click="manageCategory('del', c.id)">
            {{c.name}} ‚úï
        </span>
    </div>
</div>

<hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

<div class="field">
    <label>–ö–ê–¢–ï–ì–û–†–ò–Ø</label>
    <select v-model="newP.category" class="input-admin">
        <option v-for="c in categories" :key="c.id" :value="c.name">{{c.name}}</option>
    </select>
</div>

<div class="field">
    <label>–¢–û–í–ê–†: –ù–ê–ó–í–ê–ù–ò–ï</label>
    <input v-model="newP.title" class="input-admin">
</div>

<div class="field">
    <label>–û–ü–ò–°–ê–ù–ò–ï</label>
    <textarea v-model="newP.desc" class="input-admin" style="height:80px;"></textarea>
</div>

<div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
    <div class="field">
        <label>–¶–ï–ù–ê (‚ÇΩ)</label>
        <input v-model="newP.price" type="number" class="input-admin">
    </div>
    <div class="field">
        <label>–°–¢–ê–†–ê–Ø –¶–ï–ù–ê (SALE)</label>
        <input v-model="newP.oldPrice" type="number" class="input-admin">
    </div>
</div>

<div class="field" style="margin-top: 10px;">
    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
        <input type="checkbox" v-model="newP.isNew" style="width: 18px; height: 18px; accent-color: #000;"> 
        –ü–û–°–¢–ê–í–ò–¢–¨ –ü–õ–ê–®–ö–£ "NEW"
    </label>
</div>

<hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

<div style="margin-top: 20px;">
    <label style="font-weight: 800; font-size: 12px; margin-bottom: 15px; display: block;">üé® –¶–í–ï–¢–ê, –†–ê–ó–ú–ï–†–´ –ò –§–û–¢–û (–¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ü–≤–µ—Ç–∞ –æ—Ç–¥–µ–ª—å–Ω–æ)</label>
    
    <!-- –ö–ê–ñ–î–´–ô –¶–í–ï–¢ - –û–¢–î–ï–õ–¨–ù–´–ô –ë–õ–û–ö -->
   <div v-for="(v, vIdx) in newP.variants" :key="vIdx" 
     class="variant-block"  
     style="border: 2px solid #000; padding: 15px; margin-top: 15px; border-radius: 8px; background: #fafafa; position: relative;">
        
        <!-- –ó–ê–ì–û–õ–û–í–û–ö –¶–í–ï–¢–ê –° –ö–ù–û–ü–ö–û–ô –£–î–ê–õ–ï–ù–ò–Ø -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h4 style="font-size: 11px; font-weight: 800; text-transform: uppercase; margin: 0; color: #000;">
                –¶–í–ï–¢ #{{ vIdx + 1 }} <span v-if="v.color" style="color: #007aff;">({{ v.color }})</span>
            </h4>
            <button v-if="vIdx > 0" @click="removeVariant(vIdx)" 
                    style="background: #ff3b30; color: white; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-weight: bold; font-size: 14px;">
                ‚úï
            </button>
        </div>

        <!-- –ù–ê–ó–í–ê–ù–ò–ï –¶–í–ï–¢–ê -->
        <div class="field">
            <label>–ù–ê–ó–í–ê–ù–ò–ï –¶–í–ï–¢–ê</label>
            <input v-model="v.color" class="input-admin" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ß–µ—Ä–Ω—ã–π, –ë–µ–ª—ã–π, –ö—Ä–∞—Å–Ω—ã–π">
        </div>
        <div class="field" style="margin-top: 10px;">
    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
        <input type="checkbox" v-model="v.hidden" style="width: 18px; height: 18px; accent-color: #000;"> 
        –°–∫—Ä—ã—Ç—å —ç—Ç–æ—Ç —Ü–≤–µ—Ç
    </label>
</div>
        <!-- –†–ê–ó–ú–ï–†–´ –ò –û–°–¢–ê–¢–ö–ò –î–õ–Ø –≠–¢–û–ì–û –¶–í–ï–¢–ê -->
        <div class="field" style="margin-top: 15px;">
            <label>–†–ê–ó–ú–ï–†–´ –ò –û–°–¢–ê–¢–ö–ò (–¥–ª—è —ç—Ç–æ–≥–æ —Ü–≤–µ—Ç–∞)</label>
            
            <div style="display: flex; flex-direction: column; gap: 10px; margin: 12px 0; background: #f9f9f9; padding: 15px; border-radius: 8px;">
                
                <!-- –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ï –ü–û–õ–Ø –î–õ–Ø –†–ê–ó–ú–ï–†–û–í -->
                <div v-for="(sizeField, index) in (tempSizes[vIdx] || [])" 
                     :key="'size_' + vIdx + '_' + index" 
                     style="display: flex; align-items: center; gap: 12px; padding: 10px; background: white; border-radius: 6px; border: 1px solid #e0e0e0;">
                    
                    <!-- –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ -->
                    <input type="text" 
                           v-model="sizeField.name"
                           @input="syncSizeToStocks(vIdx, index)"
                           :data-variant="vIdx"
                           :data-field="index"
                           style="width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-weight: 700; font-size: 12px; text-align: center;"
                           placeholder="–†–∞–∑–º–µ—Ä">
                    
                    <span style="color: #999; font-weight: 800; font-size: 14px;">√ó</span>
                    
                    <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ -->
                    <input type="number" 
                           v-model.number="sizeField.qty"
                           min="0"
                           @input="syncSizeToStocks(vIdx, index)"
                           style="width: 70px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; text-align: center;"
                           placeholder="0">
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –Ω–µ –ø–µ—Ä–≤—ã–π —Ä–∞–∑–º–µ—Ä) -->
                    <button v-if="index > 0" 
                            @click="removeSizeField(vIdx, index)" 
                            type="button" 
                            style="margin-left: auto; background: #ff3b30; color: white; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 14px; font-weight: bold; flex-shrink: 0;">
                        √ó
                    </button>
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ -->
               <button type="button" 
        @click="addSizeField(vIdx)"
        style="display: flex; align-items: center; justify-content: center; gap: 4px; width: 100%; padding: 5px; background: #000000; color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: 600; font-size: 8px; margin-top: 5px; letter-spacing: 0.2px;">
    <span style="font-size: 10px;">+</span>
    –î–û–ë–ê–í–ò–¢–¨ –†–ê–ó–ú–ï–†
</button>
            </div>
        </div>

<div class="field" style="margin-top: 15px;">
    <label>–§–û–¢–û –î–õ–Ø –¶–í–ï–¢–ê "{{ v.color || '...' }}"</label>
    
    <input 
        type="file" 
        multiple 
        @change="handleFileUpload($event, vIdx)"
        class="input-admin" 
        style="padding: 8px;" 
        accept="image/*"
        :disabled="!v.color">
    
    <div v-if="!v.color" style="font-size: 10px; color: #ff3b30; margin-top: 5px;">
        ‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ —É–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ü–≤–µ—Ç–∞
    </div>
    
    <!-- –ò–ù–î–ò–ö–ê–¢–û–† –ó–ê–ì–†–£–ó–ö–ò -->
    <div v-if="uploadState.isUploading" style="margin: 10px 0; padding: 8px; background: #f0f0f0; border-radius: 6px;">
        <div style="font-size: 10px; font-weight: 700; margin-bottom: 5px;">
            –ó–∞–≥—Ä—É–∑–∫–∞: {{ uploadState.uploadedFiles }} –∏–∑ {{ uploadState.totalFiles }}
        </div>
        <div style="height: 4px; background: #ddd; border-radius: 2px; overflow: hidden;">
            <div :style="{ 
                width: uploadState.progress + '%', 
                height: '100%', 
                background: '#000', 
                transition: 'width 0.3s' 
            }"></div>
        </div>
    </div>
    
    <!-- –ì–û–†–ò–ó–û–ù–¢–ê–õ–¨–ù–ê–Ø –°–ï–¢–ö–ê –ü–†–ï–í–¨–Æ -->
    <div class="preview-container" style="margin-top: 15px;">
        
        <!-- 1. –°–£–©–ï–°–¢–í–£–Æ–©–ò–ï –§–û–¢–û –ò–ó –ë–ê–ó–´ -->
        <div v-if="v.images && v.images.length > 0" 
             style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;">
            <div v-for="(img, imgIdx) in v.images" 
                 :key="'db_' + vIdx + '_' + imgIdx" 
                 style="position: relative; width: 60px; height: 60px; flex-shrink: 0;">
                <img :src="img" alt="–ü—Ä–µ–≤—å—é" 
                     style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px; border: 2px solid #34c759;"
                     @error="handleImageError">
                <button @click="removeVariantImage(vIdx, imgIdx)" 
                        style="position: absolute; top: -5px; right: -5px; background: #ff3b30; color: white; width: 18px; height: 18px; border-radius: 50%; border: 1px solid white; font-size: 10px; cursor: pointer; z-index: 2;">
                    ‚úï
                </button>
                <div style="position: absolute; bottom: 2px; left: 2px; background: #34c759; color: white; 
                            font-size: 7px; padding: 1px 3px; border-radius: 2px;">
                    ‚úì
                </div>
            </div>
        </div>
        
        <!-- 2. –§–ê–ô–õ–´ –í –û–ß–ï–†–ï–î–ò (–û–ë–™–ï–î–ò–ù–ï–ù–ù–´–ô –ú–ê–°–°–ò–í) -->
        <div v-if="v.fileQueue && v.fileQueue.length > 0" 
             style="display: flex; flex-wrap: wrap; gap: 8px;">
            <div v-for="file in v.fileQueue" 
                 :key="file.id" 
                 style="position: relative; width: 60px; height: 60px; flex-shrink: 0;">
                
                <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–µ–≤—å—é -->
                <div style="position: relative; width: 100%; height: 100%;">
                    
                    <!-- –ü—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
                    <img :src="file.preview" alt="–ü—Ä–µ–≤—å—é"
                         style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px;"
                         :style="{ 
                             opacity: file.status === 'uploading' ? 0.7 : 1,
                             border: file.status === 'completed' ? '2px solid #34c759' : 
                                     file.status === 'failed' ? '2px solid #ff3b30' : '1px solid #ddd'
                         }"
                         @error="handleImageError">
                    
                    <!-- –ò–ù–î–ò–ö–ê–¢–û–† –ó–ê–ì–†–£–ó–ö–ò -->
                    <div v-if="file.status === 'uploading'" 
                         style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
                                display: flex; align-items: center; justify-content: center; 
                                background: rgba(255,255,255,0.9); border-radius: 6px;">
                        
                        <!-- –ü—Ä–æ—Å—Ç–æ–π —Å–ø–∏–Ω–Ω–µ—Ä -->
                        <div class="loader-mini"></div>
                    </div>
                    
                    <!-- –°–¢–ê–¢–£–° –ò–ö–û–ù–ö–ò -->
                    <div v-if="file.status === 'completed'" 
                         style="position: absolute; top: -4px; right: -4px; background: #34c759; 
                                color: white; width: 16px; height: 16px; border-radius: 50%; 
                                display: flex; align-items: center; justify-content: center; 
                                font-size: 10px; font-weight: bold; border: 1px solid white; z-index: 2;">
                        ‚úì
                    </div>
                    
                    <div v-if="file.status === 'failed'" 
                         style="position: absolute; top: -4px; right: -4px; background: #ff3b30; 
                                color: white; width: 16px; height: 16px; border-radius: 50%; 
                                display: flex; align-items: center; justify-content: center; 
                                font-size: 10px; font-weight: bold; border: 1px solid white; z-index: 2;">
                        !
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è -->
                    <button @click="removeFileFromQueue(vIdx, file.id)" 
                            style="position: absolute; bottom: -4px; right: -4px; 
                                   background: #ff3b30; color: white; width: 16px; height: 16px; 
                                   border-radius: 50%; border: 1px solid white; 
                                   font-size: 9px; cursor: pointer; z-index: 2;">
                        ‚úï
                    </button>
                </div>
                
                <!-- –ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏ —Å—Ç–∞—Ç—É—Å (–¢–û–õ–¨–ö–û –î–õ–Ø –î–ï–°–ö–¢–û–ü–ê) -->
                <div class="file-info-desktop" style="display: none;">
                    <div style="font-size: 8px; text-align: center; margin-top: 2px; 
                                font-weight: 600; overflow: hidden; text-overflow: ellipsis; 
                                white-space: nowrap;">
                        {{ file.name?.substring(0, 8) || '–§–∞–π–ª' }}{{ file.name?.length > 8 ? '...' : '' }}
                    </div>
                    <div :style="{ 
                        color: file.status === 'completed' ? '#34c759' : 
                               file.status === 'failed' ? '#ff3b30' : 
                               file.status === 'uploading' ? '#007aff' : '#999',
                        fontSize: '7px', textAlign: 'center'
                    }">
                        {{ 
                            file.status === 'uploading' ? '–ó–∞–≥—Ä...' :
                            file.status === 'completed' ? '–ì–æ—Ç–æ–≤–æ' :
                            file.status === 'failed' ? '–û—à–∏–±–∫–∞' : '–û–∂–∏–¥–∞–µ—Ç'
                        }}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –°–û–û–ë–©–ï–ù–ò–ï –ï–°–õ–ò –ù–ï–¢ –§–û–¢–û -->
        <div v-if="(!v.images || v.images.length === 0) && 
                  (!v.fileQueue || v.fileQueue.length === 0)" 
             style="text-align: center; padding: 15px; color: #999; font-size: 10px; border: 1px dashed #ddd; border-radius: 6px; width: 100%;">
            üì∏ –ù–∞–∂–º–∏—Ç–µ "–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã" —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ –¥–ª—è —ç—Ç–æ–≥–æ —Ü–≤–µ—Ç–∞
            <div style="font-size: 8px; margin-top: 5px; color: #666;">
                –ú–∞–∫—Å–∏–º—É–º {{ IMAGE_LIMITS.MAX_TOTAL_IMAGES }} —Ñ–æ—Ç–æ, –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª –¥–æ {{ IMAGE_LIMITS.MAX_FILE_SIZE / (1024*1024) }}MB
            </div>
        </div>
    </div>
</div>
        
        <!-- –†–ê–ó–î–ï–õ–ò–¢–ï–õ–¨ –ú–ï–ñ–î–£ –¶–í–ï–¢–ê–ú–ò -->
        <div v-if="vIdx < newP.variants.length - 1" 
             style="margin-top: 20px; padding-top: 15px; border-top: 2px dashed #ddd;">
            <div style="text-align: center; font-size: 10px; color: #666; font-weight: 700;">
                ‚¨á –°–ª–µ–¥—É—é—â–∏–π —Ü–≤–µ—Ç ‚¨á
            </div>
        </div>
    </div>

    <!-- –ö–ù–û–ü–ö–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ù–û–í–û–ì–û –¶–í–ï–¢–ê -->
    <button type="button" class="btn-black" @click="addVariant" 
            style="margin-top: 20px; background: #28a745 !important; width: 100%;">
        <span style="font-size: 16px; margin-right: 8px;">+</span>
        –î–û–ë–ê–í–ò–¢–¨ –ï–©–ï –û–î–ò–ù –¶–í–ï–¢
    </button>
    

    <!-- –ö–ù–û–ü–ö–ò –°–û–•–†–ê–ù–ï–ù–ò–Ø -->
    <div style="margin-top: 25px;">
        <button class="btn-black" style="width:100%;" @click="saveProduct" :disabled="loading">
            {{ loading ? 'üîÑ –ó–ê–ì–†–£–ó–ö–ê...' : (editId ? 'üíæ –°–û–•–†–ê–ù–ò–¢–¨ –ò–ó–ú–ï–ù–ï–ù–ò–Ø' : 'üöÄ –û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨ –¢–û–í–ê–†') }}
        </button>
        <button v-if="editId" class="cat-tab" style="width:100%; margin-top:10px;" @click="cancelEdit">
            ‚ùå –û–¢–ú–ï–ù–ê
        </button>
    </div>
</div>
   <div style="margin-top: 20px; border: 1px solid #eee; border-radius: 12px; overflow: hidden; background: #f9f9f9;">
  <div @click="showProductList = !showProductList" style="padding: 15px; background: #000; color: #fff; display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
    <span style="font-weight: 800; font-size: 11px; letter-spacing: 1px;">
        üì¶ –°–ü–ò–°–û–ö –¢–û–í–ê–†–û–í ({{ products.length }})
        <span v-if="editId" style="color: #007aff; margin-left: 10px;">
            ‚ö° –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏...
        </span>
    </span>
    <span style="font-size: 18px;">{{ showProductList ? '‚àí' : '+' }}</span>
</div>
    
 <div v-if="showProductList" class="stable-list" style="padding: 5px; background: #fff;">
    <template v-for="p in products" :key="p.id">
        <div v-for="(v, vIdx) in p.variants" :key="p.id + vIdx" 
             class="fixed-item"
             style="padding: 15px; border-bottom: 2px solid #f2f2f7; background: #fff;">
            
            <div style="display: flex; gap: 15px;">
                <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: —Ñ–æ—Ç–æ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div style="display: flex; gap: 15px; flex: 1; min-width: 0;">
                    <img :src="getVariantImage(v) || defaultPlaceholder" 
     style="width: 55px; height: 75px; object-fit: cover; border-radius: 8px; border: 1px solid #eee; flex-shrink: 0;"
     class="product-image"
     loading="lazy"
     decoding="async"
     @error="handleImageError">
                    
                    <div style="flex: 1; min-width: 0;">
                        <div class="product-title" style="font-weight: 800; font-size: 13px; text-transform: uppercase; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            {{ p.title }}
                        </div>
                        <div class="product-color" style="font-size: 11px; color: #000; font-weight: 700; margin-bottom: 12px;">
                            –¶–í–ï–¢: {{ v.color }}
                        </div>
                        
                        <!-- –°–ï–¢–ö–ê –†–ê–ó–ú–ï–†–û–í -->
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <!-- –î–ª—è –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ -->
                            <div v-for="(qty, sz) in (v.stocks || v.stock || {})" :key="sz" 
                                 style="display: flex; align-items: center; justify-content: space-between;
                                        background: #f9f9f9; padding: 8px; border-radius: 8px; 
                                        border: 1px solid #eee; min-width: 0;"
                                 class="size-item">
                                
                                <!-- –†–∞–∑–º–µ—Ä —Å–ª–µ–≤–∞ -->
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 14px; font-weight: 700; 
                                                 color: #000; text-transform: uppercase;"
                                          class="size-name">
                                        {{ sz }}:
                                    </span>
                                </div>
                                
                                <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –∫–Ω–æ–ø–∫–∏ —Å–ø—Ä–∞–≤–∞ -->
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    
                                    <!-- –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ -->
                                    <template v-if="p.editingVariant === vIdx && !p.fullEditMode">
                                        <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                                        <input type="number" 
                                               v-model.number="v.stocks[sz]" 
                                               min="0"
                                               step="1"
                                               @input="v.editState = true"
                                               style="width: 50px; min-width: 50px; 
                                                      border: 1px solid #007aff; 
                                                      border-radius: 6px; padding: 5px; 
                                                      font-size: 13px; font-weight: bold; 
                                                      text-align: center; background: #fff; 
                                                      box-shadow: 0 0 0 1px #007aff; flex-shrink: 0;">
                                        
                                        <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ -->
                                        <button @click="removeSizeFromVariant(p, vIdx, sz)" 
                                                type="button" 
                                                style="width: 22px; height: 22px; border-radius: 4px; 
                                                       border: none; background: #ff3b30; color: white; 
                                                       font-weight: bold; font-size: 14px; cursor: pointer; 
                                                       display: flex; align-items: center; justify-content: center;
                                                       flex-shrink: 0;"
                                                class="delete-size-btn">
                                            √ó
                                        </button>
                                    </template>
                                    
                                    <!-- –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä -->
                                    <template v-else>
                                        <!-- –ü—Ä–æ—Å—Ç–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ -->
                                        <span style="font-size: 13px; font-weight: 700; color: #000;"
                                              class="stock-value">
                                            {{ qty }}
                                        </span>
                                    </template>
                                </div>
                            </div>
                            
                            
                        </div>
                    </div>
                </div>
                
                <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                <div class="control-buttons-compact" style="flex-shrink: 0; width: 55px; min-width: 55px;">
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ 1: –ë—ã—Å—Ç—Ä–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ ‚úèÔ∏è -->
                    <button @click="toggleQuickEdit(p, vIdx)" 
                            :style="{ 
                                background: (p.editingVariant === vIdx && !p.fullEditMode) ? '#007aff' : '#f5f5f5',
                                color: (p.editingVariant === vIdx && !p.fullEditMode) ? '#fff' : '#000'
                            }"
                            :title="(p.editingVariant === vIdx && !p.fullEditMode) ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Å—Ç–∞—Ç–∫–∏' : '–ë—ã—Å—Ç—Ä–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤'"
                            class="control-btn-compact"
                            style="width: 45px; height: 45px;">
                        {{ (p.editingVariant === vIdx && !p.fullEditMode) ? 'üíæ' : '‚úèÔ∏è' }}
                    </button>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ 2: –ü–æ–ª–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ üìù -->
                    <button @click="editFullProduct(p)" 
                            :style="{ 
                                background: p.fullEditMode ? '#007aff' : '#f5f5f5',
                                color: p.fullEditMode ? '#fff' : '#000'
                            }"
                            :title="p.fullEditMode ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ' : '–ü–æ–ª–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏'"
                            class="control-btn-compact"
                            style="width: 45px; height: 45px;">
                        üìù
                    </button>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ 3: –°–∫—Ä—ã—Ç—å/–ø–æ–∫–∞–∑–∞—Ç—å —Ç–æ–≤–∞—Ä -->
                    <button @click="toggleVariantVisibility(p, vIdx)" 
        :style="{ 
            background: v.hidden ? '#34c759' : '#f5f5f5',
            color: v.hidden ? '#fff' : '#000'
        }"
        :title="v.hidden ? '–ü–æ–∫–∞–∑–∞—Ç—å —Ü–≤–µ—Ç' : '–°–∫—Ä—ã—Ç—å —Ü–≤–µ—Ç'"
        class="control-btn-compact"
        style="width: 45px; height: 45px;">
    {{ v.hidden ? 'üëÅ' : 'üëÅ‚Äçüó®' }}
</button>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ 4: –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä -->
                    <button @click="deleteProductWithConfirm(p.id)" 
                            style="background: #f5f5f5;"
                            title="–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä"
                            class="control-btn-compact"
                            style="width: 45px; height: 45px;">
                        üóë
                    </button>
                </div>
            </div>
        </div>
    </template>
</div>

        <hr style="margin: 20px 0; border: none; border-top: 2px solid #000;">   
        <h3 class="brand-name" style="font-size:12px; margin-top:2px;">–ó–ê–ö–ê–ó–´ ({{allOrders.length}}) | –í–´–†–£–ß–ö–ê: {{revenue}} ‚ÇΩ</h3>
        
        <div v-for="o in allOrders" :key="o.id" class="order-card" style="background: #ffffff; border-radius: 20px; padding: 16px; margin-bottom: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.03);">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                <div><div style="font-weight: 800; font-size: 16px; display: block;">#{{ o.order_id }}</div></div>
                <div @click="deleteOrder(o.id); vib()" style="color: #ff3b30; font-size: 10px; font-weight: 800; cursor: pointer; border: 1.5px solid #ff3b30; padding: 4px 8px; border-radius: 8px; text-transform: uppercase;">–£–î–ê–õ–ò–¢–¨ üóë</div>
            </div>
            <div style="font-size: 13px; color: #000; margin-bottom: 12px; line-height: 1.4;">
                <div style="margin-bottom: 2px;">üë§ <b>{{ o.customer_name }}</b></div>
                <div style="margin-bottom: 2px;">üìû <span style="color: #007aff;">{{ o.customer_phone }}</span></div>
                <div style="color: #8e8e93; font-size: 12px;">üìç {{ o.address }} ({{ o.delivery || o.delivery_type }})</div>
            </div>
            <div style="background: #f2f2f7; padding: 10px; border-radius: 12px; margin-bottom: 15px;">
                <div v-if="o.items && o.items.length > 0">
                    <div v-for="item in o.items" :key="item.id" style="font-size: 12px; margin-bottom: 6px; border-bottom: 1px solid #e5e5ea; padding-bottom: 4px; color: #000;">
                        <div style="font-weight: 700;">{{ item.title }} ‚Äî {{ item.count || 1 }} —à—Ç.</div>
                        <div style="font-size: 11px; color: #8e8e93;">üé® –¶–≤–µ—Ç: {{ item.color || '-' }} | üìè –†–∞–∑–º: {{ item.size || item.selSize || '-' }}</div>
                    </div>
                </div>
                <div v-else style="font-size: 12px; white-space: pre-wrap;">{{ o.items_text }}</div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <span style="font-size: 11px; font-weight: 700; color: #8e8e93;">–ò–¢–û–ì–û –ö –û–ü–õ–ê–¢–ï</span>
                <span style="font-size: 18px; font-weight: 800;">{{ o.order_total }} ‚ÇΩ</span>
            </div>
            <div style="display: flex; gap: 8px;">
                <button @click="updateStatus(o, '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω')" :disabled="o.status === '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω' || o.status === '–î–æ—Å—Ç–∞–≤–ª–µ–Ω' || o.isUpdating" :style="{ flex: '1', height: '46px', borderRadius: '12px', border: 'none', fontSize: '10px', fontWeight: '800', background: (o.status === '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω' || o.status === '–î–æ—Å—Ç–∞–≤–ª–µ–Ω') ? '#34c759' : '#ff3b30', color: '#fff' }">{{ (o.status === '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω' || o.status === '–î–æ—Å—Ç–∞–≤–ª–µ–Ω') ? '–û–¢–ü–†–ê–í–õ–ï–ù–û ‚úÖ' : '–û–¢–ü–†–ê–í–ò–¢–¨' }}</button>
                <button @click="updateStatus(o, '–î–æ—Å—Ç–∞–≤–ª–µ–Ω')" :disabled="o.status === '–î–æ—Å—Ç–∞–≤–ª–µ–Ω' || o.isUpdating" :style="{ flex: '1', height: '46px', borderRadius: '12px', border: 'none', fontSize: '10px', fontWeight: '800', background: o.status === '–î–æ—Å—Ç–∞–≤–ª–µ–Ω' ? '#34c759' : '#ff3b30', color: '#fff' }">{{ o.status === '–î–æ—Å—Ç–∞–≤–ª–µ–Ω' ? '–î–û–°–¢–ê–í–õ–ï–ù–û ‚úÖ' : '–î–û–°–¢–ê–í–ò–¢–¨' }}</button>
                <button @click="printOrder(o)" style="width: 46px; height: 46px; border-radius: 12px; border: 1px solid #eee; background: #fff; font-size: 20px; display: flex; align-items: center; justify-content: center;">üìÑ</button>
            </div>
        </div>      
    </div> </div> </main>

  <div v-if="selP" class="modal" style="z-index: 5000;">
    <button class="close-modal" @click="closeProductModal()">‚úï</button>

    <div class="slider-wrapper" style="aspect-ratio: 1/1.2; position: relative; background: #f9f9f9;">
        <template v-if="selP.variants && selP.variants[currentVariantIndex]">
            <!-- –í products-grid (–∫–∞—Ç–∞–ª–æ–≥) -->
<div class="slider-inner" id="modalSlider" 
     @scroll="e => handleScroll(e, selP)">
   <img v-for="(img, idx) in (selP.variants[currentVariantIndex]?.images || [])" 
         :key="idx" 
         :src="img" 
         :alt="'–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ' + (idx + 1)"
         loading="lazy"
         decoding="async"
         @error="handleImageError"
         class="product-image">
</div>
            
            <div class="dots" v-if="selP.variants[currentVariantIndex].images.length > 1">
                <span v-for="(img, i) in selP.variants[currentVariantIndex].images" 
                      :key="i" :class="['dot', {active: i === (selP.aIdx || 0)}]">
                </span>
            </div>
        </template>
        <div v-else style="display:flex; align-items:center; justify-content:center; height:100%; color:#999; font-size:12px;">
            –ó–ê–ì–†–£–ó–ö–ê...
        </div>
    </div>

    <div v-if="selP.variants && selP.variants[currentVariantIndex]" style="padding: 25px;">
        
       <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px; margin-bottom: 16px;">
    <h2 class="brand-name" style="font-size: 12px; margin:0; text-transform: uppercase; font-weight: 700;">
        {{ selP.title }}
    </h2>
    
    <!-- –ë–õ–û–ö –° –¶–ï–ù–ê–ú–ò, –°–¢–ê–†–û–ô –¶–ï–ù–û–ô –ò –ü–†–û–¶–ï–ù–¢–û–ú –°–ö–ò–î–ö–ò -->
    <div style="display: flex; align-items: baseline; gap: 8px; flex-wrap: wrap;">
        <!-- –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ (–∫–∞–∫ –±—ã–ª–æ) -->
        <div class="price" style="font-size: 18px; font-weight: 800;">
            {{ selP.price }} ‚ÇΩ
        </div>
        
        <!-- –°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞ (–∑–∞—á–µ—Ä–∫–Ω—É—Ç–∞—è) - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å -->
        <span v-if="selP.oldPrice" 
              style="font-size: 14px; color: #8e8e93; text-decoration: line-through; font-weight: 600;">
            {{ selP.oldPrice }} ‚ÇΩ
        </span>
        
        <!-- –ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Å—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞ -->
        <span v-if="selP.oldPrice" 
              style="background: #ff3b30; color: white; font-size: 11px; font-weight: 800; padding: 2px 6px; border-radius: 2px; margin-left: 4px;">
            -{{ Math.round((1 - selP.price / selP.oldPrice) * 100) }}%
        </span>
    </div>
</div>
        
        
      <div style="display: flex; gap: 8px; margin-bottom: 8px; overflow-x: auto; padding-bottom: 2px; scrollbar-width: none;">
    <div v-for="(v, idx) in visibleVariants" :key="idx" 
         @click="currentVariantIndex = getOriginalIndexFromVisible(selP, idx); selP.tempSize = null; vib();"
         :class="['color-badge', { active: currentVariantIndex === getOriginalIndexFromVisible(selP, idx) }]"
         style="padding: 8px 16px; border: 1px solid #eee; border-radius: 20px; font-size: 12px; cursor: pointer; white-space: nowrap; transition: 0.2s;"
         :style="{ background: currentVariantIndex === getOriginalIndexFromVisible(selP, idx) ? '#000' : '#fff', color: currentVariantIndex === getOriginalIndexFromVisible(selP, idx) ? '#fff' : '#000' }">
        {{ v.color }}
    </div>
</div>

       <div class="size-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 30px;">
    <template v-for="(qty, sz) in (selP.variants[currentVariantIndex]?.stocks || {})" :key="sz">
        
        <button v-if="!(selP.hiddenSizes || []).includes(String(sz).trim())"
                @click="qty > 0 ? (selP.tempSize = sz, vib()) : null"
                :class="['size-btn', { active: selP.tempSize === sz }]"
                :disabled="qty <= 0"
                :style="{
                    height: '45px',
                    border: '1px solid #eee',
                    borderRadius: '8px',
                    fontSize: '13px',
                    fontWeight: '700',
                    transition: '0.2s',
                    background: selP.tempSize === sz ? '#000' : (qty <= 0 ? '#f9f9f9' : '#fff'),
                    color: selP.tempSize === sz ? '#fff' : (qty <= 0 ? '#ccc' : '#000'),
                    opacity: qty <= 0 ? '0.6' : '1',
                    position: 'relative',
                    cursor: qty <= 0 ? 'not-allowed' : 'pointer'
                }">
            {{ sz }}
            <div v-if="qty > 0 && qty < 5" 
                 style="font-size: 7px; color: #ff3b30; position: absolute; bottom: 4px; width: 100%; text-align: center;">
                {{qty}} —à—Ç.
            </div>
        </button>
        
    </template>
</div>
<div style="position: relative; margin: 20px 0 30px 0; padding-top: 15px; border-top: 1px solid #f0f0f0;">
        <div 
            style="font-size: 13px; line-height: 1.5; color: #444; cursor: pointer;"
            @click="toggleDescription(selP.id)"
        >
            <!-- –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ -->
            <div v-if="expandedDescriptionId !== selP.id">
                {{ getShortDescription(selP.desc) }}
                <span style="color: #000; font-weight: 600; font-size: 11px; margin-left: 5px; text-decoration: none;">
                    –ü–æ–¥—Ä–æ–±–Ω–µ–µ ‚Ä∫
                </span>
            </div>
            
            <!-- –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ -->
            <div v-else>
                {{ selP.desc || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç' }}
                <div style="color: #000; font-weight: 600; font-size: 11px; margin-top: 10px;">
                    –°–≤–µ—Ä–Ω—É—Ç—å ‚Äπ
                </div>
            </div>
        </div>
    </div>
        <div style="display: flex; gap: 10px;">
            <button @click="toggleFav(selP)" 
        style="width: 60px; height: 50px; border: 1px solid #eee; border-radius: 8px; background: #fff; display: flex; align-items: center; justify-content: center; color: #000;">
    <svg :fill="isFav(selP) ? '#000' : 'none'" viewBox="0 0 24 24" width="22" height="22" stroke="currentColor" stroke-width="2">
        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
    </svg>
</button>
            
            <button class="add-to-cart-btn" 
                    @click="addToCart(selP)" 
                    :disabled="!selP.tempSize"
                    style="flex: 1; height: 50px; border: none; border-radius: 8px; font-weight: 800; letter-spacing: 1px; transition: 0.3s;"
                    :style="{ background: selP.tempSize ? '#000' : '#ccc', color: '#fff' }">
                <span v-if="selP.tempSize">–í –ö–û–†–ó–ò–ù–£</span>
                <span v-else>–í–´–ë–ï–†–ò–¢–ï –†–ê–ó–ú–ï–†</span>
            </button>
        </div>
    </div> </div> <nav class="bottom-nav">
    <button v-for="btn in nav" :key="btn.id" 
        @click="setTab(btn.id)" 
        :class="['nav-item', {active: tab === btn.id}]"> 
        <div v-if="btn.id === 'cart' && cart.length > 0" class="badge">
            {{cart.length}}
        </div>
        <svg v-html="btn.icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"></svg>
        <span>{{btn.label}}</span>
    </button>
</nav>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
        getFirestore, 
        collection, 
        addDoc, 
        onSnapshot, 
        query, 
        orderBy, 
        doc, 
        deleteDoc, 
        updateDoc, 
        where, 
        getDoc, 
        getDocs,
        serverTimestamp,  // ‚Üê –î–û–ë–ê–í–ò–¢–¨ –≠–¢–û!
        Timestamp 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC6fihIMtOYZuPh-db3Tc6eiRgSikzydVw",
¬† authDomain: "naran-80077.firebaseapp.com",
¬† projectId: "naran-80077",
¬† storageBucket: "naran-80077.firebasestorage.app",
¬† messagingSenderId: "901156477154",
¬† appId: "1:901156477154:web:9bf2d604496726b59ae6bb",
¬† measurementId: "G-PR8PLCMF3C"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    
    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ –Ω—É–∂–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    window.db = db;
    window.storage = storage;
    window.fb = {
        // Firestore —Ñ—É–Ω–∫—Ü–∏–∏
        collection: collection,
        addDoc: addDoc,
        onSnapshot: onSnapshot,
        query: query,
        getDoc: getDoc,
        orderBy: orderBy,
        doc: doc,
        getFirestore: getFirestore,
        getDocs: getDocs,
        deleteDoc: deleteDoc,
        updateDoc: updateDoc,
        where: where,
        db: db,
        serverTimestamp: serverTimestamp, // ‚Üê –¢–µ–ø–µ—Ä—å —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è!
        Timestamp: Timestamp,
        
        // Storage —Ñ—É–Ω–∫—Ü–∏–∏
        getDownloadURL: getDownloadURL,
        ref: ref,
        uploadBytes: uploadBytes,
        storage: storage  // ‚Üê –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –ø–æ–ª–Ω–æ—Ç—ã
    };
</script>

<script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—Å–µ—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
document.addEventListener('error', function(e) {
    if (e.target.tagName === 'IMG' && e.target.src.includes('via.placeholder.com')) {
        e.target.src = 'data:image/svg+xml;base64,...';
    }
}, true);
const tg = window.Telegram.WebApp;

Vue.createApp({
  data() {
    return {
        showCartNotify: false,
        catalogActiveColors: {}, // { productId: colorIndex }
         productActiveVariantIndex: {},
        // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ===
        IMGBB_API_KEY: '4d4ab43d9b15c3dbadb9058518e4db23',
        IMGBB_UPLOAD_URL: 'https://api.imgbb.com/1/upload',
        
        // === –ï–î–ò–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï –ó–ê–ì–†–£–ó–ö–ò ===
        uploadState: {
            isUploading: false,
            progress: 0,
            totalFiles: 0,
            uploadedFiles: 0,
            errors: []
        },
        
        // === –ö–≠–® –ò –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø ===
        imageCache: new Map(),
        defaultPlaceholder: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQwMCIgdmlld0JveD0iMCAwIDMwMCA0MDAiIGZpbGw9IiNmZmYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyMCIgZmlsbD0iIzAwMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg==',
        
        // === –õ–ò–ú–ò–¢–´ ===
        IMAGE_LIMITS: {
            MAX_FILE_SIZE: 5 * 1024 * 1024, // 5MB
            MAX_TOTAL_IMAGES: 10,
            MAX_WIDTH: 1200,
            MAX_HEIGHT: 1600,
            QUALITY: 0.8
        },
        
        // === –í–†–ï–ú–ï–ù–ù–´–ï –î–ê–ù–ù–´–ï –î–õ–Ø –§–û–†–ú–´ ===
       tempSizes: [[]], // –ü–µ—Ä–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –∏–º–µ–µ—Ç –æ–¥–Ω–æ –ø—É—Å—Ç–æ–µ –ø–æ–ª–µ
        newSizeFields: {}, // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ —Ä–∞–∑–º–µ—Ä–æ–≤
        
        // === –û–°–ù–û–í–ù–´–ï –°–û–°–¢–û–Ø–ù–ò–Ø ===
        showNewSizeFields: false,
        editUploading: false,
        expandedDescriptionId: null,
        selVariantIdx: 0,
        tab: 'catalog',
        currentCat: '',
        searchQuery: '',
        searchMode: false,
        burgerOpen: false,
        loading: false,
        showProductList: false,
        activeInfo: null,
        
        // === –î–ê–ù–ù–´–ï ===
        products: [],
        categories: [],
        cart: JSON.parse(localStorage.getItem('naran_cart_v3') || '[]'),
        favorites: JSON.parse(localStorage.getItem('naran_favs_v3') || '[]'),
        
        user: {},
        isAdmin: false,
        adminIds: [387881523],
        
        selP: false,
        currentVariantIndex: 0,
        deliv: '',
        address: '',
        map: null,
        form: {
            name: '',
            phone: localStorage.getItem('naran_phone') || '',
            address: ''
        },
        
        // === –î–ê–ù–ù–´–ï –î–õ–Ø –§–û–†–ú–´ –¢–û–í–ê–†–ê ===
        newP: {
            title: '',
            desc: '',
            price: null,
            oldPrice: null,
            category: '',
            isNew: false,
            hidden: false,
            variants: [
                { 
                    color: '', 
                    images: [], 
                    stocks: {},
                    // –¢–û–õ–¨–ö–û –û–î–ò–ù –ú–ê–°–°–ò–í –î–õ–Ø –§–ê–ô–õ–û–í
                    fileQueue: []
                }
            ]
        },
        newCat: '',
        editId: null,
        allOrders: [],
        chart: null,
        myOrders: [],
        
        // === –ù–ê–í–ò–ì–ê–¶–ò–Ø ===
        nav: [
            { id: 'catalog', label: '–ö–∞—Ç–∞–ª–æ–≥', icon: '<rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect>' },
            { id: 'favs', label: '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ', icon: '<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>' },
            { id: 'cart', label: '–ö–æ—Ä–∑–∏–Ω–∞', icon: '<circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>' },
            { id: 'profile', label: '–ü—Ä–æ—Ñ–∏–ª—å', icon: '<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle>' }
        ]
    }
},
    computed: {
        stats() {
    const now = new Date();
    const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();

    let todayCount = 0, todayRev = 0;
    let monthCount = 0, monthRev = 0;
    let allCount = 0, allRev = 0;

    this.allOrders.forEach(o => {
        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –î–ê–¢–´
        let orderDate = 0;
        
        if (o.createdAt) {
            // –ï—Å–ª–∏ —ç—Ç–æ Firebase Timestamp
            if (o.createdAt.seconds !== undefined) {
                orderDate = o.createdAt.seconds * 1000;
            }
            // –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–æ (Date.now())
            else if (typeof o.createdAt === 'number') {
                orderDate = o.createdAt;
            }
            // –ï—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞
            else if (typeof o.createdAt === 'string') {
                orderDate = new Date(o.createdAt).getTime();
            }
        }
        
        // –ï—Å–ª–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ 0, –ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
        if (!orderDate && o.date) {
            orderDate = new Date(o.date).getTime();
        }
        
        const total = parseFloat(o.order_total) || parseFloat(o.total) || 0;

        allCount++;
        allRev += total;

        if (orderDate >= startOfMonth) {
            monthCount++;
            monthRev += total;
        }

        if (orderDate >= startOfDay) {
            todayCount++;
            todayRev += total;
        }
    });

    return { todayCount, todayRev, monthCount, monthRev, allCount, allRev };
},
    cartTotal() {
    return this.total(); // –ù–µ –¥–æ–±–∞–≤–ª—è–π—Ç–µ 200 —Ä—É–±–ª–µ–π!
},
    adminProducts() {
        if (!this.products) return [];
        const q = (this.searchQuery || '').toLowerCase().trim();
        return this.products.filter(p => 
            p.title.toLowerCase().includes(q) || 
            (p.color && p.color.toLowerCase().includes(q))
        );
    },
     filteredProducts() {
    if (!this.products || !Array.isArray(this.products)) return [];
    
    try {
        const query = (this.searchQuery || '').toLowerCase().trim();
        const targetCat = (this.currentCat || '').toLowerCase().trim();

        return this.products.filter(p => {
            if (!p) return false;

            // –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–∫—Ä—ã—Ç - –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
            if (p?.hidden === true) return false;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ù–ï —Å–∫—Ä—ã—Ç—ã—Ö —Ü–≤–µ—Ç–æ–≤
            const hasVisibleVariants = p.variants?.some(variant => 
                !variant.hidden && 
                variant.images && 
                variant.images.length > 0
            );

            if (!hasVisibleVariants) return false;

            // –û—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏...
            const titleMatch = query === '' || 
                (p.title && String(p.title).toLowerCase().includes(query));

            let catMatch = true;
            if (targetCat !== '' && targetCat !== '–≤—Å–µ') {
                const prodCat = p.category ? String(p.category).toLowerCase().trim() : '';
                catMatch = (prodCat === targetCat);
            }

            return titleMatch && catMatch;
        });
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:", e);
        return [];
    }
},
visibleVariants() {
    if (!this.selP || !this.selP.variants) return [];
    return this.selP.variants.filter(v => !v.hidden);
},
selVariant() {
        if (!this.openedProduct || !this.openedProduct.variants) return {};
        return this.openedProduct.variants[this.selVariantIdx] || this.openedProduct.variants[0];
    },
        favList() {
            if (!this.products) return [];
            return this.products.filter(p => this.favorites.includes(p.id));
        },

        // 2. –°—á–∏—Ç–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –®–¢–£–ö –≤ –∫–æ—Ä–∑–∏–Ω–µ (–¥–ª—è –∫—Ä–∞—Å–Ω–æ–≥–æ –∫—Ä—É–∂–∫–∞ –Ω–∞ –∏–∫–æ–Ω–∫–µ)
      cartCount() {
    return this.cart.reduce((sum, item) => sum + (item.qty || 1), 0);
},

        // 3. –°—á–∏—Ç–∞–µ—Ç –í–´–†–£–ß–ö–£ –≤—Å–µ—Ö –∑–∞–∫–∞–∑–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏)
        revenue() {
                return this.allOrders.reduce((sum, o) => {
                    const val = Number(String(o.order_total || o.total || 0).replace(/\s/g, ''));
                    return sum + val;
                }, 0);
            },
    },
  watch: {
    products: {
        handler(newProducts) {
            // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ü–≤–µ—Ç–∞ –¥–ª—è —Å–∫—Ä—ã—Ç—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
            this.$nextTick(() => {
                newProducts.forEach(product => {
                    if (product && product.id) {
                        const currentIndex = this.catalogActiveColors[product.id] || 0;
                        const visibleVariants = product.variants?.filter(v => !v.hidden) || [];
                        
                        // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Å–∫—Ä—ã—Ç—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –∏–ª–∏ –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
                        if (currentIndex >= visibleVariants.length) {
                            this.catalogActiveColors[product.id] = 0;
                        }
                    }
                });
            });
        },
        deep: true
    }
},
    methods: {
        vib() { tg.HapticFeedback.impactOccurred('light'); },
total() {
    if (!this.cart || !Array.isArray(this.cart) || this.cart.length === 0) {
        return 0;
    }
    
    const itemsTotal = this.cart.reduce((sum, item) => {
        // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—ã
        let price = 0;
        if (typeof item.price === 'number') {
            price = item.price;
        } else if (typeof item.price === 'string') {
            price = parseFloat(item.price.replace(/[^\d.]/g, '')) || 0;
        }
        
        const qty = parseInt(item.qty || item.count || 1) || 0;
        return sum + (price * qty);
    }, 0);
    
    return itemsTotal;
},

removeEditImage(imgIdx) {
    if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Ñ–æ—Ç–æ –∏–∑ —Ç–æ–≤–∞—Ä–∞?")) {
        this.editImages.splice(imgIdx, 1);
        this.vib();
    }
},
async updateStock(product, size) {
    // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    if (product.editingVariant !== null) {
        const variant = product.variants[product.editingVariant];
        variant.editState = true;
        this.vib();
        return;
    }
    
    // –ò–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ä–∞–∑—É
    try {
        const productRef = window.fb.doc(window.db, "products", product.id);
        await window.fb.updateDoc(productRef, {
            variants: product.variants,
            updatedAt: Date.now()
        });
        
        this.vib();
        this.showTempMessage('‚úÖ –û—Å—Ç–∞—Ç–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω');
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–∞:", e);
        alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + e.message);
    }
},
// –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∏–Ω–¥–µ–∫—Å –≤–∏–¥–∏–º–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –≤ —Ä–µ–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –≤ –º–∞—Å—Å–∏–≤–µ variants
getOriginalVariantIndex(product, visibleIndex) {
    if (!product.variants) return 0;
    
    let visibleCount = 0;
    for (let i = 0; i < product.variants.length; i++) {
        if (!product.variants[i].hidden) {
            if (visibleCount === visibleIndex) {
                return i;
            }
            visibleCount++;
        }
    }
    return 0;
},
// –ü–æ–ª—É—á–∏—Ç—å –ø–µ—Ä–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–∞
getVariantImage(variant) {
    if (!variant) return this.defaultPlaceholder;
    if (variant.images && variant.images.length > 0) {
        return variant.images[0];
    }
    return this.defaultPlaceholder;
},
// === –ï–î–ò–ù–´–ô –ú–ï–¢–û–î –î–õ–Ø –û–ë–†–ê–ë–û–¢–ö–ò –§–ê–ô–õ–û–í ===
async handleFileUpload(event, variantIndex) {
    const files = Array.from(event.target.files);
    if (files.length === 0) return;
    
    const variant = this.newP.variants[variantIndex];
    if (!variant) return;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—á–µ—Ä–µ–¥—å —Ñ–∞–π–ª–æ–≤ –µ—Å–ª–∏ –µ–µ –Ω–µ—Ç
    if (!variant.fileQueue) {
        variant.fileQueue = [];
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç—ã
    const totalImages = this.countTotalImages();
    if (totalImages + files.length > this.IMAGE_LIMITS.MAX_TOTAL_IMAGES) {
        alert(`–ú–∞–∫—Å–∏–º—É–º ${this.IMAGE_LIMITS.MAX_TOTAL_IMAGES} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –°–µ–π—á–∞—Å: ${totalImages}`);
        return;
    }
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª
    for (const file of files) {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞
        if (!file.type.startsWith('image/')) {
            alert(`–§–∞–π–ª "${file.name}" –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º`);
            continue;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞
        if (file.size > this.IMAGE_LIMITS.MAX_FILE_SIZE) {
            alert(`–§–∞–π–ª "${file.name}" —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (${(file.size / (1024 * 1024)).toFixed(1)}MB). –ú–∞–∫—Å–∏–º—É–º 5MB.`);
            continue;
        }
        
        // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Ñ–∞–π–ª–∞
        const fileObj = {
            id: Date.now() + Math.random(),
            file: file,
            preview: URL.createObjectURL(file),
            name: file.name,
            size: file.size,
            type: file.type,
            status: 'pending',
            progress: 0,
            error: null
        };
        
        variant.fileQueue.push(fileObj);
    }
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º input
    event.target.value = '';
    
    // –í–∏–±—Ä–∞—Ü–∏—è
    this.vib();
},

// === –ü–û–î–°–ß–ï–¢ –í–°–ï–• –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π) ===
countTotalImages() {
    let count = 0;
    
    if (!this.newP.variants) return 0;
    
    this.newP.variants.forEach(variant => {
        // –¢–û–õ–¨–ö–û –¥–≤–∞ –º–∞—Å—Å–∏–≤–∞: images –∏ fileQueue
        if (variant.images) count += variant.images.length;
        if (variant.fileQueue) count += variant.fileQueue.length;
        // –£–î–ê–õ–ò–¢–¨: localFiles –∏ uploadingFiles - –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º
    });
    
    return count;
},
// === –£–î–ê–õ–ï–ù–ò–ï –§–ê–ô–õ–ê –ò–ó –û–ß–ï–†–ï–î–ò ===
removeFileFromQueue(variantIndex, fileId) {
    const variant = this.newP.variants[variantIndex];
    if (!variant || !variant.fileQueue) return;
    
    const index = variant.fileQueue.findIndex(f => f.id === fileId);
    if (index > -1) {
        const file = variant.fileQueue[index];
        
        // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–∞–º—è—Ç—å
        if (file.preview && file.preview.startsWith('blob:')) {
            URL.revokeObjectURL(file.preview);
        }
        
        variant.fileQueue.splice(index, 1);
        this.vib();
    }
},
resetForm() {
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é
    this.newP = {
        title: '',
        desc: '',
        price: null,
        oldPrice: null,
        category: '',
        isNew: false,
        hidden: false,
        variants: [
            { 
                color: '', 
                images: [], 
                stocks: {},
                fileQueue: []
            }
        ]
    };
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
    this.tempSizes = [[]];
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    this.editId = null;
    this.fullEditMode = false;
},
// === –£–î–ê–õ–ï–ù–ò–ï –°–£–©–ï–°–¢–í–£–Æ–©–ï–ì–û –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø –ò–ó –í–ê–†–ò–ê–ù–¢–ê ===
removeVariantImage(vIdx, imgIdx) {
    if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Ñ–æ—Ç–æ –∏–∑ —Ç–æ–≤–∞—Ä–∞?")) {
        this.newP.variants[vIdx].images.splice(imgIdx, 1);
        this.vib();
    }
},

async uploadVariantFiles(variantIndex) {
    const variant = this.newP.variants[variantIndex];
    if (!variant || !variant.fileQueue || variant.fileQueue.length === 0) {
        return []; // –ù–µ—Ç —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
    }
    
    const uploadedUrls = [];
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
    this.uploadState.totalFiles = variant.fileQueue.length;
    this.uploadState.uploadedFiles = 0;
    this.uploadState.isUploading = true;
    
    for (let i = 0; i < variant.fileQueue.length; i++) {
        const fileObj = variant.fileQueue[i];
        
        try {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            fileObj.status = 'uploading';
            fileObj.progress = 10;
            
            // –°–∂–∏–º–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥)
            const compressedFile = await this.compressImageFast(fileObj.file);
            fileObj.progress = 40;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞ ImgBB (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥)
            const imageUrl = await this.uploadFileToImgBB(compressedFile);
            fileObj.progress = 100;
            fileObj.status = 'completed';
            
            if (imageUrl) {
                uploadedUrls.push(imageUrl);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
            fileObj.status = 'failed';
            fileObj.error = error.message;
            
            // Fallback: Data URL –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
            if (fileObj.file.size < 100 * 1024) {
                try {
                    const dataUrl = await this.fileToDataURL(fileObj.file);
                    uploadedUrls.push(dataUrl);
                    fileObj.status = 'completed';
                } catch (dataError) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è Data URL:', dataError);
                }
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        this.uploadState.uploadedFiles = i + 1;
        this.uploadState.progress = Math.round(((i + 1) / variant.fileQueue.length) * 100);
    }
    
    this.uploadState.isUploading = false;
    return uploadedUrls;
},

handleImageError(event) {
    const img = event.target;
    
    // –ï—Å–ª–∏ —É–∂–µ –∑–∞–º–µ–Ω—è–ª–∏ - –≤—ã—Ö–æ–¥–∏–º
    if (img.src.includes('base64')) return;
    
    // –ó–∞–º–µ–Ω—è–µ–º –Ω–∞ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
    img.src = this.defaultPlaceholder;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
    img.classList.add('image-error');
    
    // –û—Ç–∫–ª—é—á–∞–µ–º –¥–∞–ª—å–Ω–µ–π—à–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫
    img.onerror = null;
},

    setCategory(name) {
    try {
        this.vib();
        this.currentCat = name || '';
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ü–≤–µ—Ç–∞
        this.catalogActiveColors = {};
        this.correctAllActiveColors();
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    } catch (err) {
        console.error("–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:", err);
        this.currentCat = '';
    }
},
toggleDescription(productId) {
        if (this.expandedDescriptionId === productId) {
            this.expandedDescriptionId = null;
        } else {
            this.expandedDescriptionId = productId;
        }
        this.vib();
    },
    // –ú–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
// –ú–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
getVisibleVariants(product) {
    if (!product || !product.variants) return [];
    return product.variants.filter(v => !v.hidden);
},

// –ú–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ —Ü–≤–µ—Ç–∞ —Å—Ä–µ–¥–∏ –≤–∏–¥–∏–º—ã—Ö
getActiveColorIndex(product) {
    if (!product || !product.id || !product.variants) return 0;
    
    let currentIndex = this.catalogActiveColors[product.id] || 0;
    
    // –ü–æ–ª—É—á–∞–µ–º –≤–∏–¥–∏–º—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
    const visibleVariants = product.variants.filter(v => !v.hidden);
    
    // –ï—Å–ª–∏ –Ω–µ—Ç –≤–∏–¥–∏–º—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
    if (visibleVariants.length === 0) return 0;
    
    // –ù–∞—Ö–æ–¥–∏–º, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ —Ç–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å –≤–∏–¥–∏–º–æ–º—É –≤–∞—Ä–∏–∞–Ω—Ç—É
    if (currentIndex >= visibleVariants.length) {
        currentIndex = 0;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–∫—Ä—ã—Ç –ª–∏ —Ç–µ–∫—É—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç
    const originalIndex = this.getOriginalIndexFromVisible(product, currentIndex);
    if (product.variants[originalIndex]?.hidden) {
        currentIndex = 0;
    }
    
    // –í Vue 3 –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–µ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏–µ
    this.catalogActiveColors[product.id] = currentIndex;
    return currentIndex;
},
// –ü–æ–ª—É—á–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –∏–∑ –≤–∏–¥–∏–º–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞
getOriginalIndexFromVisible(product, visibleIndex) {
    if (!product.variants) return 0;
    
    let visibleCount = 0;
    for (let i = 0; i < product.variants.length; i++) {
        if (!product.variants[i].hidden) {
            if (visibleCount === visibleIndex) {
                return i;
            }
            visibleCount++;
        }
    }
    return 0;
},

// –ú–µ—Ç–æ–¥ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤–∏–¥–∏–º–æ–≥–æ —Ü–≤–µ—Ç–∞
selectVisibleColor(product, variant) {
    if (!product || !product.variants) return;
    
    // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å —ç—Ç–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Å—Ä–µ–¥–∏ –í–ò–î–ò–ú–´–•
    const visibleVariants = product.variants.filter(v => !v.hidden);
    const visibleIndex = visibleVariants.findIndex(v => v.color === variant.color);
    
    if (visibleIndex !== -1) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω–¥–µ–∫—Å –≤–∏–¥–∏–º–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ (–ø—Ä—è–º–æ–µ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏–µ –≤ Vue 3)
        this.catalogActiveColors[product.id] = visibleIndex;
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ø—Ä–∏ —Å–º–µ–Ω–µ —Ü–≤–µ—Ç–∞
        product.tempSize = null;
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        this.$forceUpdate();
        
        this.vib();
    }
},
 getProductImages(product) {
    if (!product || !product.id || !product.variants) {
        return [this.defaultPlaceholder];
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –¢–û–õ–¨–ö–û –ù–ï –°–ö–†–´–¢–´–ï –≤–∞—Ä–∏–∞–Ω—Ç—ã
    const visibleVariants = product.variants.filter(v => !v.hidden);
    
    if (!visibleVariants || visibleVariants.length === 0) {
        return [this.defaultPlaceholder];
    }
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ü–≤–µ—Ç (—Ç–æ–ª—å–∫–æ —Å—Ä–µ–¥–∏ –≤–∏–¥–∏–º—ã—Ö)
    const activeIndex = this.getActiveColorIndex(product);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –º–∞—Å—Å–∏–≤–∞
    if (activeIndex >= visibleVariants.length) {
        this.catalogActiveColors[product.id] = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—ã–π –≤–∏–¥–∏–º—ã–π
        return visibleVariants[0]?.images || [this.defaultPlaceholder];
    }
    
    const activeVariant = visibleVariants[activeIndex];
    
    // –ë–µ—Ä–µ–º —Ñ–æ—Ç–æ –¢–û–õ–¨–ö–û –∏–∑ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –í–ò–î–ò–ú–û–ì–û –≤–∞—Ä–∏–∞–Ω—Ç–∞
    if (activeVariant && activeVariant.images && activeVariant.images.length > 0) {
        return activeVariant.images.filter(img => 
            img && typeof img === 'string' && 
            (img.startsWith('http://') || 
             img.startsWith('https://') || 
             img.startsWith('data:image/'))
        );
    }
    
    return [this.defaultPlaceholder];
},

    getShortDescription(fullDesc) {
        if (!fullDesc) return '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ–ø–∏—Å–∞–Ω–∏—è';
        
        // –û–±—Ä–µ–∑–∞–µ–º –¥–æ 80 —Å–∏–º–≤–æ–ª–æ–≤ –∏ –¥–æ–±–∞–≤–ª—è–µ–º "..."
        if (fullDesc.length > 80) {
            return fullDesc.substring(0, 80) + '...';
        }
        return fullDesc;
    },
    getItemImage(item) {
    // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø–æ–ª—è
    return item.img || 
           item.image || 
           (item.variants && item.variants[0]?.images?.[0]) || 
           (item.images && item.images[0]) || 
           'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQwMCIgdmlld0JveD0iMCAwIDMwMCA0MDAiIGZpbGw9IiNmZmYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyMCIgZmlsbD0iIzAwMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg==';
},
toggleEditSizes(product, variantIndex) {
    // –ï—Å–ª–∏ —É–∂–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —ç—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
    if (product.editingVariant === variantIndex) {
        this.saveVariantSizes(product, variantIndex);
        product.editingVariant = null;
    } else {
        // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –¥—Ä—É–≥–æ–π –≤–∞—Ä–∏–∞–Ω—Ç - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π
        if (product.editingVariant !== null && product.editingVariant !== undefined) {
            this.saveVariantSizes(product, product.editingVariant);
        }
        
        // –ù–∞—á–∏–Ω–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞
        product.editingVariant = variantIndex;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–ª—è –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
        const variant = product.variants[variantIndex];
        variant.newSizeName = '';
        variant.newSizeQty = 0;
        variant.editState = false;
    }
    this.vib();
},
correctAllActiveColors() {
    if (!this.products) return;
    
    this.products.forEach(product => {
        if (product && product.variants) {
            const currentIndex = this.catalogActiveColors[product.id] || 0;
            const visibleVariants = product.variants.filter(v => !v.hidden);
            
            // –ï—Å–ª–∏ –∏–Ω–¥–µ–∫—Å —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Å–∫—Ä—ã—Ç—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –∏–ª–∏ –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
            if (currentIndex >= visibleVariants.length) {
                this.catalogActiveColors[product.id] = 0;
            }
        }
    });
},
// –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –ø–æ I

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä—ã –≤–∞—Ä–∏–∞–Ω—Ç–∞ –≤ Firebase
async saveVariantSizes(product, variantIndex) {
    try {
        const productRef = window.fb.doc(window.db, "products", product.id);
        const variant = product.variants[variantIndex];
        
        // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª—è
        delete variant.newSizeName;
        delete variant.newSizeQty;
        delete variant.editState;
        
        // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        const updateData = {
            variants: product.variants,
            updatedAt: Date.now()
        };
        
        await window.fb.updateDoc(productRef, updateData);
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        product.editingVariant = null;
        product.fullEditMode = false;
        
        // –¢–∞–∫—Ç–∏–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫
        if (window.Telegram?.WebApp?.HapticFeedback) {
            window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        }
        
        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
        this.showTempMessage('‚úÖ –û—Å—Ç–∞—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
        
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤:", error);
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Å—Ç–∞—Ç–∫–æ–≤: " + error.message);
    }
},

// –£–¥–∞–ª–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–∞
removeSizeFromVariant(product, variantIndex, sizeName) {
    if (confirm(`–£–¥–∞–ª–∏—Ç—å —Ä–∞–∑–º–µ—Ä "${sizeName}"?`)) {
        const variant = product.variants[variantIndex];
        if (variant.stocks && variant.stocks[sizeName] !== undefined) {
            delete variant.stocks[sizeName];
            variant.editState = true; // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–π
        }
        this.vib();
    }
},


    removeVariant(vIdx) {
        if (confirm(`–£–¥–∞–ª–∏—Ç—å —Ü–≤–µ—Ç "${this.newP.variants[vIdx].color || '–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}"?`)) {
            this.newP.variants.splice(vIdx, 1);
            this.tempSizes.splice(vIdx, 1);
            this.vib();
        }
    },
 selectColorInCatalog(product, variantIndex) {
    if (!product || !product.id || !product.variants) return;
    
    // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å —ç—Ç–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Å—Ä–µ–¥–∏ –í–ò–î–ò–ú–´–•
    const visibleVariants = product.variants.filter(v => !v.hidden);
    let visibleIndex = 0;
    
    for (let i = 0; i < product.variants.length; i++) {
        if (!product.variants[i].hidden) {
            if (i === variantIndex) {
                break;
            }
            visibleIndex++;
        }
    }
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –≤–∏–¥–∏–º—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
    if (visibleIndex >= visibleVariants.length) {
        visibleIndex = 0;
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω–¥–µ–∫—Å –≤–∏–¥–∏–º–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞
    this.$set(this.catalogActiveColors, product.id, visibleIndex);
    
    // –í–∏–±—Ä–∞—Ü–∏—è
    this.vib();
},
// –í—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –º–µ—Ç–æ–¥ –≤ —Å–µ–∫—Ü–∏—é methods
resetActiveColorIfHidden(product) {
    if (!product || !product.id || !product.variants) return;
    
    const currentIndex = this.catalogActiveColors[product.id] || 0;
    
    // –ü–æ–ª—É—á–∞–µ–º –≤–∏–¥–∏–º—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
    const visibleVariants = product.variants.filter(v => !v.hidden);
    
    // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å –±–æ–ª—å—à–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–∏–¥–∏–º—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ 0
    if (currentIndex >= visibleVariants.length) {
        this.catalogActiveColors[product.id] = 0;
    }
    
    // –¢–∞–∫–∂–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä
    product.tempSize = null;
},
    
    addVariant() {
    const newIndex = this.newP.variants.length;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Å –ï–î–ò–ù–´–ú –º–∞—Å—Å–∏–≤–æ–º fileQueue
    this.newP.variants.push({
        color: '',
        images: [],
        stocks: {},
        fileQueue: [] // –¢–û–õ–¨–ö–û –û–î–ò–ù –ú–ê–°–°–ò–í –î–õ–Ø –§–ê–ô–õ–û–í
    });
    
    // –í–ê–ñ–ù–û: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º tempSizes –¥–ª—è –Ω–æ–≤–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ü–†–ê–í–ò–õ–¨–ù–û
    if (!this.tempSizes) {
        this.tempSizes = [];
    }
    
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –º–∞—Å—Å–∏–≤ –¥–ª—è —ç—Ç–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞
    this.tempSizes[newIndex] = [];
    
    // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤–æ–µ –ø—É—Å—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è —Ä–∞–∑–º–µ—Ä–∞
    this.tempSizes[newIndex].push({
        name: '',
        qty: 0,
        savedName: ''
    });
    
    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–æ–≤–æ–º—É —Ü–≤–µ—Ç—É
    this.$nextTick(() => {
        const newColorElement = document.querySelectorAll('.variant-block')[newIndex];
        if (newColorElement) {
            newColorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    });
    
    this.vib();
},
// –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä –≤ –≤–∞—Ä–∏–∞–Ω—Ç
addSizeToVariant(product, variantIndex) {
    const variant = product.variants[variantIndex];
    const sizeName = (variant.newSizeName || '').trim().toUpperCase();
    const qty = Number(variant.newSizeQty) || 0;
    
    if (!sizeName) {
        alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞");
        return;
    }
    
    if (qty < 0) {
        alert("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º");
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π —Ä–∞–∑–º–µ—Ä
    if (variant.stocks && variant.stocks[sizeName] !== undefined) {
        alert(`–†–∞–∑–º–µ—Ä "${sizeName}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`);
        return;
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä
    if (!variant.stocks) variant.stocks = {};
    variant.stocks[sizeName] = qty;
    variant.editState = true;
    
    // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞
    variant.newSizeName = '';
    variant.newSizeQty = 0;
    
    this.vib();
},

// –ü–æ–∫–∞–∑–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
showTempMessage(text) {
    const msgEl = document.createElement('div');
    msgEl.textContent = text;
    msgEl.style.cssText = `
        position: fixed;
        top: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.9);
        color: white;
        padding: 12px 24px;
        border-radius: 12px;
        font-weight: 700;
        font-size: 14px;
        z-index: 9999;
        animation: fadeInOut 2s ease;
    `;
    
    document.body.appendChild(msgEl);
    
    setTimeout(() => {
        if (msgEl.parentNode) {
            document.body.removeChild(msgEl);
        }
    }, 2000);
},
       setTab(id) {
    if (this.vib) this.vib(); 
    this.tab = id;

    if (id === 'favs') {
        this.$nextTick(() => {
            this.updateFavListWithTempSize();
        });
    }

    // –ï—Å–ª–∏ –ø–µ—Ä–µ—à–ª–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å, —Ä–∏—Å—É–µ–º –≥—Ä–∞—Ñ–∏–∫
    if (id === 'profile') {
        this.$nextTick(() => {
            // –î–∞–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ DOM
            setTimeout(() => {
                if (this.isAdmin) { // –í–∞–∂–Ω–æ: –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –∞–¥–º–∏–Ω
                    this.updateChart();
                }
            }, 300); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è
        });
    }
},
// –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –≤—ã–±—Ä–∞–Ω –ª–∏ —Ä–∞–∑–º–µ—Ä —É —Ç–æ–≤–∞—Ä–∞
hasSelectedSize(p) {
    return !!p.tempSize;
},
 async toggleProductVisibility(p) {
        try {
            const productRef = window.fb.doc(window.db, "products", p.id);
            await window.fb.updateDoc(productRef, {
                hidden: !p.hidden
            });
            
            this.vib('light');
            alert(p.hidden ? '–¢–æ–≤–∞—Ä –ø–æ–∫–∞–∑–∞–Ω' : '–¢–æ–≤–∞—Ä —Å–∫—Ä—ã—Ç');
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞:", e);
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞");
        }
    },
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç –¥–ª—è –∫–Ω–æ–ø–∫–∏
getAddToCartText(p) {
    if (!p.tempSize) {
        return '–í–´–ë–ï–†–ò–¢–ï –†–ê–ó–ú–ï–†';
    }
    return '–í –ö–û–†–ó–ò–ù–£';
},

// –ú–µ—Ç–æ–¥ –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É
getProductSizes(p) {
    if (!p) return [];
    const stocks = this.getStocksObject(p);
    return Object.keys(stocks);
},
// –í methods: –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥
async toggleVariantVisibility(product, variantIndex) {
    try {
        const variant = product.variants[variantIndex];
        
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–∫—Ä—ã—Ç–∏–µ
        const newHiddenState = !variant.hidden;
        variant.hidden = newHiddenState;
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ü–≤–µ—Ç –µ—Å–ª–∏ –æ–Ω —Å—Ç–∞–ª —Å–∫—Ä—ã—Ç—ã–º
        const currentIndex = this.catalogActiveColors[product.id] || 0;
        if (currentIndex >= variantIndex) {
            // –ò—â–µ–º —Å–ª–µ–¥—É—é—â–∏–π –≤–∏–¥–∏–º—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
            const visibleVariants = product.variants.filter(v => !v.hidden);
            if (visibleVariants.length > 0) {
                // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å –ø–µ—Ä–≤–æ–≥–æ –≤–∏–¥–∏–º–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞
                const firstVisibleIndex = product.variants.findIndex(v => !v.hidden);
                this.catalogActiveColors[product.id] = this.getVisibleIndexFromOriginal(product, firstVisibleIndex);
            } else {
                this.catalogActiveColors[product.id] = 0;
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase
        const productRef = window.fb.doc(window.db, "products", product.id);
        await window.fb.updateDoc(productRef, {
            variants: product.variants,
            updatedAt: Date.now()
        });
        
        this.vib('light');
        alert(newHiddenState ? '–¶–≤–µ—Ç —Å–∫—Ä—ã—Ç' : '–¶–≤–µ—Ç –ø–æ–∫–∞–∑–∞–Ω');
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        this.$forceUpdate();
        
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞:", e);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å —Ü–≤–µ—Ç–∞");
    }
},
// –ü–æ–ª—É—á–∏—Ç—å –≤–∏–¥–∏–º—ã–π –∏–Ω–¥–µ–∫—Å –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞
getVisibleIndexFromOriginal(product, originalIndex) {
    if (!product.variants || originalIndex < 0) return 0;
    
    let visibleCount = 0;
    for (let i = 0; i < originalIndex; i++) {
        if (!product.variants[i].hidden) {
            visibleCount++;
        }
    }
    return visibleCount;
},
addSizeField(vIdx) {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ –¥–ª—è —ç—Ç–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    if (!this.tempSizes) {
        this.tempSizes = [];
    }
    
    if (!this.tempSizes[vIdx]) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º Vue.set –¥–ª—è —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        this.$set(this.tempSizes, vIdx, []);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –ø—É—Å—Ç–æ–µ –ø–æ–ª–µ
    this.tempSizes[vIdx].push({
        name: '',
        qty: 0,
        savedName: ''
    });
    
    // –§–æ–∫—É—Å –Ω–∞ –Ω–æ–≤–æ–º –ø–æ–ª–µ
    this.$nextTick(() => {
        const lastIndex = this.tempSizes[vIdx].length - 1;
        const inputSelector = `[data-variant="${vIdx}"][data-field="${lastIndex}"]`;
        const input = document.querySelector(inputSelector);
        if (input) {
            input.focus();
        }
    });
},
// –£–¥–∞–ª–∏—Ç—å –ø–æ–ª–µ —Ä–∞–∑–º–µ—Ä–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π)
removeSizeField(vIdx, fieldIndex) {
    if (fieldIndex === 0) return; // –ù–µ —É–¥–∞–ª—è–µ–º –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ
    
    const field = this.tempSizes[vIdx][fieldIndex];
    
    // –ï—Å–ª–∏ –ø–æ–ª–µ –±—ã–ª–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ, —É–¥–∞–ª—è–µ–º –∏–∑ stocks
    if (field.name && field.name.trim()) {
        const sizeName = field.name.trim();
        if (this.newP.variants[vIdx].stocks && 
            this.newP.variants[vIdx].stocks[sizeName] !== undefined) {
            delete this.newP.variants[vIdx].stocks[sizeName];
        }
    }
    
    // –£–¥–∞–ª—è–µ–º –ø–æ–ª–µ –∏–∑ –º–∞—Å—Å–∏–≤–∞
    this.tempSizes[vIdx].splice(fieldIndex, 1);
    this.vib();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º DOM
    this.$forceUpdate();
},
editProduct(p) {
    const list = document.querySelector('.stable-list');
    const scrollPos = list ? list.scrollTop : 0;
    
    const cleanItem = JSON.parse(JSON.stringify(p));
    this.editId = p.id;
    this.fullEditMode = true;
    
    // –û—á–∏—â–∞–µ–º —Ä–µ–∂–∏–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤
    this.products.forEach(prod => {
        prod.editingVariant = null;
        prod.fullEditMode = false;
    });
    
    // 1. –ó–∞–ø–æ–ª–Ω—è–µ–º newP –¥–∞–Ω–Ω—ã–º–∏ —Ç–æ–≤–∞—Ä–∞
    this.newP = {
        title: cleanItem.title || '',
        desc: cleanItem.desc || '',
        price: cleanItem.price || null,
        oldPrice: cleanItem.oldPrice || null,
        category: cleanItem.category || '',
        isNew: !!cleanItem.isNew,
        hidden: !!cleanItem.hidden,
        hiddenSizes: cleanItem.hiddenSizes || [],
        variants: []
    };
    
    // 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º tempSizes
    this.tempSizes = [];
    
    // 3. –ö–æ–ø–∏—Ä—É–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ü–≤–µ—Ç–æ–≤ (–í–ê–ñ–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º fileQueue –≤–º–µ—Å—Ç–æ —Å—Ç–∞—Ä—ã—Ö –º–∞—Å—Å–∏–≤–æ–≤)
    if (cleanItem.variants && cleanItem.variants.length > 0) {
        this.newP.variants = cleanItem.variants.map(variant => ({
            color: variant.color || '–°—Ç–∞–Ω–¥–∞—Ä—Ç',
            images: variant.images || [],
            stocks: variant.stocks || variant.stock || {},
            fileQueue: [] // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—É—Å—Ç—É—é –æ—á–µ—Ä–µ–¥—å –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
        }));
        
        // 4. –î–ª—è –ö–ê–ñ–î–û–ì–û –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Å–æ–∑–¥–∞–µ–º tempSizes
        this.newP.variants.forEach((variant, vIdx) => {
            const fields = [];
            const stocks = variant.stocks || {};
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ä–∞–∑–º–µ—Ä–æ–≤
            Object.keys(stocks).forEach(sizeName => {
                fields.push({
                    name: sizeName,
                    qty: stocks[sizeName] || 0,
                    savedName: sizeName
                });
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–¥–Ω–æ –ø—É—Å—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –Ω–æ–≤—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤
            fields.push({
                name: '',
                qty: 0,
                savedName: ''
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ tempSizes –¥–ª—è —ç—Ç–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞
            this.tempSizes[vIdx] = fields;
        });
        
    } else {
        // –î–ª—è —Å—Ç–∞—Ä—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –±–µ–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Å–æ–∑–¥–∞–µ–º –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç
        this.newP.variants = [
            { 
                color: cleanItem.color || '–°—Ç–∞–Ω–¥–∞—Ä—Ç', 
                images: cleanItem.images || [], 
                stocks: cleanItem.stocks || cleanItem.stock || {},
                fileQueue: [] // –í–∞–∂–Ω–æ: –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º fileQueue
            }
        ];
        
        // –°–æ–∑–¥–∞–µ–º –ø–æ–ª—è –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞
        const fields = [];
        const stocks = this.newP.variants[0].stocks || {};
        
        Object.keys(stocks).forEach(sizeName => {
            fields.push({
                name: sizeName,
                qty: stocks[sizeName] || 0,
                savedName: sizeName
            });
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–¥–Ω–æ –ø—É—Å—Ç–æ–µ –ø–æ–ª–µ
        fields.push({
            name: '',
            qty: 0,
            savedName: ''
        });
        
        this.tempSizes[0] = fields;
    }
    
    // 5. –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    this.showProductList = false;
    window.scrollTo(0, 0);
    
    console.log('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:', cleanItem.title);
    console.log('–í–∞—Ä–∏–∞–Ω—Ç—ã:', this.newP.variants);
    
    this.$nextTick(() => {
        if (list) list.scrollTop = scrollPos;
    });
},
toggleQuickEdit(product, variantIndex) {
    // –ï—Å–ª–∏ —É–∂–µ –≤ —Ä–µ–∂–∏–º–µ –±—ã—Å—Ç—Ä–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —ç—Ç–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ - —Å–æ—Ö—Ä–∞–Ω—è–µ–º
    if (product.editingVariant === variantIndex && !product.fullEditMode) {
        this.saveVariantSizes(product, variantIndex);
        product.editingVariant = null;
        product.fullEditMode = false;
        this.showNewSizeFields = false; // —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    } else {
        // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –¥—Ä—É–≥–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –∏–ª–∏ –ø–æ–ª–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ
        if (product.editingVariant !== null && product.editingVariant !== undefined) {
            if (product.fullEditMode) {
                // –ï—Å–ª–∏ –±—ã–ª–æ –ø–æ–ª–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                this.saveFullProduct(product);
            } else {
                // –ï—Å–ª–∏ –±—ã–ª–æ –±—ã—Å—Ç—Ä–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Å—Ç–∞—Ç–∫–∏
                this.saveVariantSizes(product, product.editingVariant);
            }
        }
        
        // –ù–∞—á–∏–Ω–∞–µ–º –±—ã—Å—Ç—Ä–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        product.editingVariant = variantIndex;
        product.fullEditMode = false;
        this.showNewSizeFields = false; // —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª—è –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–ª—è –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
        const variant = product.variants[variantIndex];
        variant.newSizeName = '';
        variant.newSizeQty = 0;
        variant.editState = false;
    }
    this.vib();
},
async handleEditFiles(e) {
    const files = Array.from(e.target.files);
    if (files.length === 0) return;
    
    if (!this.editNewFiles) this.editNewFiles = [];
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞
    const totalImages = this.countTotalImages();
    if (totalImages + files.length > this.MAX_TOTAL_IMAGES) {
        alert(`–ú–∞–∫—Å–∏–º—É–º ${this.MAX_TOTAL_IMAGES} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –°–µ–π—á–∞—Å: ${totalImages}`);
        return;
    }
    
    for (let file of files) {
        if (!file.type.startsWith('image/')) {
            alert(`–§–∞–π–ª "${file.name}" –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º.`);
            continue;
        }
        
        // ‚≠ê –ï–î–ò–ù–´–ô –õ–ò–ú–ò–¢ ‚≠ê
        if (file.size > this.MAX_FILE_SIZE) {
            alert(`–§–∞–π–ª "${file.name}" —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (${(file.size / (1024 * 1024)).toFixed(1)}MB). –ú–∞–∫—Å–∏–º—É–º ${this.MAX_FILE_SIZE / (1024 * 1024)}MB.`);
            continue;
        }
        
        const previewUrl = URL.createObjectURL(file);
        
        this.editNewFiles.push({
            id: Date.now() + Math.random(),
            file: file,
            preview: previewUrl,
            name: file.name,
            size: file.size,
            type: file.type,
            status: 'pending',
            serverUrl: null,
            uploadProgress: 0
        });
        
        this.vib();
    }
    
    e.target.value = '';
},
// –£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
// –£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
removeEditImage(index) {
    if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Ñ–æ—Ç–æ –∏–∑ —Ç–æ–≤–∞—Ä–∞?")) {
        const removedImage = this.editImages[index];
        console.log('–£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ –∏–∑ –±–∞–∑—ã:', removedImage);
        
        this.editImages.splice(index, 1);
        
        // –¢–∞–∫—Ç–∏–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫
        if (window.Telegram?.WebApp?.HapticFeedback) {
            window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
        }
    }
},

// –£–¥–∞–ª–∏—Ç—å –Ω–æ–≤–æ–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ
// –£–¥–∞–ª–∏—Ç—å –Ω–æ–≤–æ–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ
removeEditNewFile(index) {
    const file = this.editNewFiles[index];
    
    if (!file) return;
    
    console.log('–£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞:', file.name);
    
    // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–∞–º—è—Ç—å –±—Ä–∞—É–∑–µ—Ä–∞
    if (file.preview) {
        URL.revokeObjectURL(file.preview);
        console.log('–ü—Ä–µ–≤—å—é URL –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω');
    }
    
    // –£–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞
    this.editNewFiles.splice(index, 1);
    
    // –¢–∞–∫—Ç–∏–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
    
    console.log('–û—Å—Ç–∞–ª–æ—Å—å —Ñ–∞–π–ª–æ–≤:', this.editNewFiles.length);
},


// –ü–æ–ª–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ (–æ—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
editFullProduct(product) {
    // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏, –µ—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –¥—Ä—É–≥–æ–π —Ç–æ–≤–∞—Ä
    if (this.editId && this.editId !== product.id) {
        if (!confirm('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –¥—Ä—É–≥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞?')) {
            this.cancelEdit(); // –û—Ç–º–µ–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        }
    }
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º—ã –±—ã—Å—Ç—Ä–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    this.products.forEach(p => {
        p.editingVariant = null;
        p.fullEditMode = false;
    });
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ editProduct
    this.editProduct(product);
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ UI
    this.showProductList = false;
    window.scrollTo(0, 0);
    this.vib();
},

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É —Ç–æ–≤–∞—Ä–∞ (–≤ —Ñ–æ—Ä–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É–∂–µ –µ—Å—Ç—å –º–µ—Ç–æ–¥ saveProduct)
// –ù–æ –¥–æ–±–∞–≤–∏–º –º–µ—Ç–æ–¥ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –ø–æ–ª–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
async saveFullProduct(product) {
    try {
        const productRef = window.fb.doc(window.db, "products", product.id);
        
        // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª—è
        const cleanedVariants = product.variants.map(variant => {
            const cleaned = { ...variant };
            delete cleaned.newSizeName;
            delete cleaned.newSizeQty;
            delete cleaned.editState;
            return cleaned;
        });
        
        const updateData = {
            title: product.title || '',
            desc: product.desc || '',
            price: Number(product.price) || 0,
            oldPrice: product.oldPrice ? Number(product.oldPrice) : null,
            category: product.category || '',
            isNew: !!product.isNew,
            hidden: !!product.hidden,
            hiddenSizes: product.hiddenSizes || [],
            variants: cleanedVariants,
            updatedAt: Date.now()
        };
        
        await window.fb.updateDoc(productRef, updateData);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        const idx = this.products.findIndex(p => p.id === product.id);
        if (idx !== -1) {
            this.products.splice(idx, 1, { 
                ...this.products[idx], 
                ...updateData,
                variants: cleanedVariants
            });
        }
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        product.editingVariant = null;
        product.fullEditMode = false;
        
        this.showTempMessage('‚úÖ –ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
        this.vib();
        
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏:", error);
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–∞—Ä—Ç–æ—á–∫–∏: " + error.message);
    }
},
cancelEdit() {
    // 1. –û—á–∏—â–∞–µ–º URL –ø—Ä–µ–≤—å—é –¥–ª—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤
    const freePreviewUrls = (filesArray) => {
        if (filesArray && Array.isArray(filesArray)) {
            filesArray.forEach(file => {
                if (file.preview && file.preview.startsWith('blob:')) {
                    URL.revokeObjectURL(file.preview);
                }
            });
        }
    };
    
    // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–∞–º—è—Ç—å –æ—Ç –≤—Å–µ—Ö –ø—Ä–µ–≤—å—é
    freePreviewUrls(this.editNewFiles);
    freePreviewUrls(this.localFiles);
    
    // 2. –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Ñ–ª–∞–≥–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    this.editId = null;
    this.fullEditMode = false;
    this.showProductList = true;
    this.showNewSizeFields = false;
    
    // 3. –û—á–∏—â–∞–µ–º –í–°–ï –º–∞—Å—Å–∏–≤—ã —Ñ–∞–π–ª–æ–≤
    this.editImages = [];
    this.editNewFiles = [];
    this.localFiles = [];
    this.tempSizes = [];
    
    // 4. –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
    this.newP = {
        title: '',
        desc: '',
        price: null,
        oldPrice: null,
        category: '',
        isNew: false,
        hidden: false,
        hiddenSizes: [],
        variants: [
            { 
                color: '', 
                images: [], 
                stocks: {},
                uploadingFiles: [] 
            }
        ]
    };
    
    // 5. –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É –í–°–ï–• —Ç–æ–≤–∞—Ä–æ–≤
    if (this.products && Array.isArray(this.products)) {
        this.products.forEach(p => {
            p.editingVariant = null;
            p.fullEditMode = false;
            p.tempSize = null;
            p.aIdx = 0;
            
            // –¢–∞–∫–∂–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª—è –≤ –≤–∞—Ä–∏–∞–Ω—Ç–∞—Ö
            if (p.variants && Array.isArray(p.variants)) {
                p.variants.forEach(v => {
                    delete v.newSizeName;
                    delete v.newSizeQty;
                    delete v.editState;
                });
            }
        });
    }
    
    // 6. –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞
    this.currentVariantIndex = 0;
    
    // 7. –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –Ω–∞–≤–µ—Ä—Ö –¥–ª—è –ª—É—á—à–µ–≥–æ UX
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // 8. –¢–∞–∫—Ç–∏–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫ (–µ—Å–ª–∏ –≤ Telegram)
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
    
    console.log('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ, –ø–∞–º—è—Ç—å –æ—á–∏—â–µ–Ω–∞');
},

// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–ª—è —Å stocks
syncSizeToStocks(vIdx, fieldIndex) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –º–∞—Å—Å–∏–≤–æ–≤
    if (!this.tempSizes || !this.tempSizes[vIdx] || !this.tempSizes[vIdx][fieldIndex]) {
        console.warn('tempSizes –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        return;
    }
    
    const field = this.tempSizes[vIdx][fieldIndex];
    const sizeName = (field.name || '').trim().toUpperCase();
    const qty = Number(field.qty) || 0;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º stocks –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
    if (!this.newP.variants[vIdx].stocks) {
        this.newP.variants[vIdx].stocks = {};
    }
    
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ä–∞–∑–º–µ—Ä –µ—Å–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
    if (field.savedName && field.savedName !== sizeName) {
        delete this.newP.variants[vIdx].stocks[field.savedName];
    }
    
    if (sizeName) {
        // –û–±–Ω–æ–≤–ª—è–µ–º stocks
        this.newP.variants[vIdx].stocks[sizeName] = qty;
        field.savedName = sizeName;
    } else if (field.savedName) {
        // –ï—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ, —É–¥–∞–ª—è–µ–º –∏–∑ stocks
        delete this.newP.variants[vIdx].stocks[field.savedName];
        field.savedName = '';
    }
},
// –£–¥–∞–ª–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä
removeSavedSize(vIdx, sizeName) {
    if (confirm(`–£–¥–∞–ª–∏—Ç—å —Ä–∞–∑–º–µ—Ä "${sizeName}"?`)) {
        delete this.newP.variants[vIdx].stocks[sizeName];
        this.vib();
    }
},
// –í –º–µ—Ç–æ–¥–µ editProduct –¥–æ–±–∞–≤—å—Ç–µ:
initTempSizesForEdit(variant) {
    const sizes = variant.stocks || {};
    const tempSizeFields = Object.keys(sizes).map(sizeName => ({
        name: sizeName,
        qty: sizes[sizeName],
        savedName: sizeName
    }));
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–¥–Ω–æ –ø—É—Å—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
    tempSizeFields.push({
        name: '',
        qty: 0,
        savedName: ''
    });
    
    return tempSizeFields;
},
// –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Ü–≤–µ—Ç–∞
removeVariant(vIdx) {
    this.newP.variants.splice(vIdx, 1);
    this.tempSizes.splice(vIdx, 1);
},


// 2. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∞–º –æ–±—ä–µ–∫—Ç —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º (—á—Ç–æ–±—ã v-model —Ä–∞–±–æ—Ç–∞–ª)
getStocksObject(p) {
    if (p.variants && p.variants[0]) {
        if (!p.variants[0].stocks) p.variants[0].stocks = {};
        return p.variants[0].stocks;
    }
    if (!p.stocks) p.stocks = {};
    return p.stocks;
},
openProductFromCart(item) {
    // –ù–∞–π—Ç–∏ –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–∞ –ø–æ ID
    const fullProduct = this.products.find(p => p.id === item.id);
    if (fullProduct) {
        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ü–≤–µ—Ç –∏ —Ä–∞–∑–º–µ—Ä
        fullProduct.tempSize = item.selSize;
        
        // –ù–∞–π—Ç–∏ –∏–Ω–¥–µ–∫—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞
        const variantIndex = fullProduct.variants.findIndex(v => 
            v.color === item.selColor || v.color === (item.color || '')
        );
        if (variantIndex > -1) {
            this.currentVariantIndex = variantIndex;
        }
        
        this.openProduct(fullProduct);
    }
},
// –ó–ê–ú–ï–ù–ò–¢–ï –º–µ—Ç–æ–¥ getProductImages() –Ω–∞ —ç—Ç–æ—Ç:
getProductImages(product) {
    if (!product || !product.id || !product.variants) {
        return [this.defaultPlaceholder];
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –¢–û–õ–¨–ö–û –ù–ï –°–ö–†–´–¢–´–ï –≤–∞—Ä–∏–∞–Ω—Ç—ã
    const visibleVariants = product.variants.filter(v => !v.hidden);
    if (!visibleVariants || visibleVariants.length === 0) {
        return [this.defaultPlaceholder];
    }
    
    // ‚ö° –í–ê–ñ–ù–û: –ù–ï –≤—ã–∑—ã–≤–∞–µ–º getActiveColorIndex(), –∏—Å–ø–æ–ª—å–∑—É–µ–º catalogActiveColors –Ω–∞–ø—Ä—è–º—É—é
    let activeIndex = this.catalogActiveColors[product.id] || 0;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –º–∞—Å—Å–∏–≤–∞
    if (activeIndex >= visibleVariants.length) {
        activeIndex = 0;
        // –ü—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º, –±–µ–∑ —Ä–µ–∫—É—Ä—Å–∏–∏
        this.catalogActiveColors[product.id] = 0;
    }
    
    const activeVariant = visibleVariants[activeIndex];
    if (activeVariant && activeVariant.images && activeVariant.images.length > 0) {
        return activeVariant.images.filter(img => 
            img && typeof img === 'string' && 
            (img.startsWith('http://') || 
             img.startsWith('https://') || 
             img.startsWith('data:image/'))
        );
    }
    
    return [this.defaultPlaceholder];
},
       handleScroll(e, p) {
    if (!p) return;
    const images = this.getProductImages(p);
    if (images.length <= 1) return;
    
    const width = e.target.offsetWidth;
    if (width > 0) {
        p.aIdx = Math.round(e.target.scrollLeft / width);
    }
},

     openProduct(p) {
    
    window.scrollTo(0,0);
    // 1. –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—ã–π –ù–ï —Å–∫—Ä—ã—Ç—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
    let firstVisibleIndex = 0;
    if (p.variants && Array.isArray(p.variants)) {
        for (let i = 0; i < p.variants.length; i++) {
            if (!p.variants[i].hidden && p.variants[i].images && p.variants[i].images.length > 0) {
                firstVisibleIndex = i;
                break;
            }
        }
    }
    
    // 1. –°–Ω–∞—á–∞–ª–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å
    this.currentVariantIndex = firstVisibleIndex;

    // 2. –î–µ–ª–∞–µ–º –≥–ª—É–±–æ–∫—É—é –∫–æ–ø–∏—é
    let productCopy = JSON.parse(JSON.stringify(p));

    // 3. –ü–†–û–í–ï–†–ö–ê: –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä —Å—Ç–∞—Ä—ã–π
    if (!productCopy.variants || !Array.isArray(productCopy.variants) || productCopy.variants.length === 0) {
        productCopy.variants = [{
            color: productCopy.color || '–°—Ç–∞–Ω–¥–∞—Ä—Ç',
            images: productCopy.images || [],
            stocks: {}
        }];
        
        if (productCopy.sizes) {
            const oldSizes = String(productCopy.sizes).split(',');
            oldSizes.forEach(s => {
                productCopy.variants[0].stocks[s.trim()] = 10;
            });
        }
    }

    // 4. –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –∞–Ω–∏–º–∞—Ü–∏–∏
    productCopy.aIdx = 0;

    // 5. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ selP (—ç—Ç–æ –ø–æ–∫–∞–∂–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ v-if="selP")
    this.selP = productCopy;

    // 6. –í—ã–±–æ—Ä —Ä–∞–∑–º–µ—Ä–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const firstVar = this.selP.variants[0];
    if (firstVar && firstVar.stocks) {
        const availableSize = Object.keys(firstVar.stocks).find(sz => firstVar.stocks[sz] > 0);
        this.selP.tempSize = availableSize || Object.keys(firstVar.stocks)[0] || null;
    } else {
        this.selP.tempSize = null;
    }

    // 7. –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É –æ—Å–Ω–æ–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.body.style.overflow = 'hidden';

    // 8. –í–∏–±—Ä–∞—Ü–∏—è
    if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
},
        isFav(p) { return p && this.favorites.includes(p.id); },
        
        toggleFav(p) {
            this.vib();
            const idx = this.favorites.indexOf(p.id);
            if (idx > -1) {
                this.favorites.splice(idx, 1);
            } else {
                this.favorites.push(p.id);
            }
            localStorage.setItem('naran_favs_v3', JSON.stringify(this.favorites));
        },

    addToCart(p) {
    if (!p) return;

    try {
        // 1. –û–ü–†–ï–î–ï–õ–Ø–ï–ú –í–ê–†–ò–ê–ù–¢ (–¶–í–ï–¢)
        // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ –∏–Ω–¥–µ–∫—Å ‚Äî —ç—Ç–æ —á–∏—Å–ª–æ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ —Å –º–∞—Å—Å–∏–≤–æ–º
        const vIdx = Number(this.currentVariantIndex) || 0;
        const variant = (p.variants && p.variants[vIdx]) ? p.variants[vIdx] : null;

        if (!variant) {
            alert("–û—à–∏–±–∫–∞: –≤—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç —Ç–æ–≤–∞—Ä–∞");
            return;
        }

        // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –Ω–∞–ø–∏—Å–∞–Ω–∏—è (stock –∏ stocks) –±–µ–∑ –¥—É–±–ª–µ–π
        const currentStock = variant.stock || variant.stocks || {};

        // 2. –û–ü–†–ï–î–ï–õ–Ø–ï–ú –†–ê–ó–ú–ï–†
        let finalSize = p.tempSize;
        
        // –ï—Å–ª–∏ —Ä–∞–∑–º–µ—Ä –Ω–µ –≤—ã–±—Ä–∞–Ω, –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –∏–∑ –æ–±—ä–µ–∫—Ç–∞ stock
        if (!finalSize) {
            finalSize = Object.keys(currentStock).find(sz => currentStock[sz] > 0);
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å—Ç—å –ª–∏ —Ç–∞–∫–æ–π —Ä–∞–∑–º–µ—Ä –∏ –Ω–µ –ø—É—Å—Ç –ª–∏ —Å–∫–ª–∞–¥
        if (!finalSize || !currentStock[finalSize] || currentStock[finalSize] <= 0) {
            alert('–≠—Ç–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ —Å–µ–π—á–∞—Å –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏');
            return;
        }

        // 3. –£–ù–ò–ö–ê–õ–¨–ù–´–ô ID (ID + –¶–≤–µ—Ç + –†–∞–∑–º–µ—Ä)
        // –ó–∞–º–µ–Ω—è–µ–º –ø—Ä–æ–±–µ–ª—ã –Ω–∞ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è –≤ ID –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ —Å—Å—ã–ª–æ–∫
        const finalColor = variant.color || '–°—Ç–∞–Ω–¥–∞—Ä—Ç';
        const cartId = `${p.id}_${finalColor}_${finalSize}`.replace(/\s+/g, '_');

        // 4. –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–õ–ò –î–û–ë–ê–í–õ–ï–ù–ò–ï
        const exist = this.cart.find(i => i.cartId === cartId);

        if (exist) {
            if (exist.qty < currentStock[finalSize]) {
                exist.qty++;
            } else {
                alert('–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –æ—Å—Ç–∞—Ç–∫–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞');
                return;
            }
        } else {
            this.cart.push({
                id: p.id,
                cartId: cartId,
                title: p.title || '–¢–æ–≤–∞—Ä',
                price: Number(p.price) || 0,
                // –ë–µ–∑–æ–ø–∞—Å–Ω–æ –±–µ—Ä–µ–º —Ñ–æ—Ç–æ –∏–º–µ–Ω–Ω–æ —ç—Ç–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞
                img: (variant.images && variant.images[0]) ? variant.images[0] : (p.images ? p.images[0] : ''),
                selSize: finalSize,
                selColor: finalColor,
                qty: 1
            });
        }
        
        // 5. –≠–§–§–ï–ö–¢–´ –ò –°–û–•–†–ê–ù–ï–ù–ò–ï
        this.saveCart();
        
        // –¢–∞–∫—Ç–∏–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫ Telegram
        if (window.Telegram?.WebApp?.HapticFeedback) {
            window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        }

        this.showCartNotify = true;
        setTimeout(() => { this.showCartNotify = false; }, 2000);

        // 6. –ó–ê–ö–†–´–¢–ò–ï –ú–û–î–ê–õ–ö–ò –ò –°–ë–†–û–° –í–´–ë–û–†–ê
        setTimeout(() => {
            this.selP = null;
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä —É –æ–±—ä–µ–∫—Ç–∞, —á—Ç–æ–±—ã –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –æ–Ω –±—ã–ª —á–∏—Å—Ç
            if (p) p.tempSize = null; 
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Ü–≤–µ—Ç–∞ –Ω–∞ –ø–µ—Ä–≤—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            this.currentVariantIndex = 0; 
        }, 300);

    } catch (err) {
        // –ó–∞—â–∏—Ç–∞ –æ—Ç "–±–µ–ª–æ–≥–æ —ç–∫—Ä–∞–Ω–∞": –µ—Å–ª–∏ –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫,
        // –æ—à–∏–±–∫–∞ –≤—ã–≤–µ–¥–µ—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å, –∞ –Ω–µ "—É—Ä–æ–Ω–∏—Ç" –≤—Å—ë –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
        console.error("–û—à–∏–±–∫–∞ –≤ addToCart:", err);
    }
},
getSizes(p) {
    if (p.variants && p.variants[0] && p.variants[0].stocks) {
        return Object.keys(p.variants[0].stocks);
    }
    if (p.stocks) {
        return Object.keys(p.stocks);
    }
    return []; // –ï—Å–ª–∏ —Ä–∞–∑–º–µ—Ä–æ–≤ –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –≤–µ—Ä–Ω–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –∏ –æ—à–∏–±–∫–∏ –Ω–µ –±—É–¥–µ—Ç
},
selectFirstAvailableSize(variant) {
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π —Ä–∞–∑–º–µ—Ä –≤ –Ω–æ–≤–æ–º —Ü–≤–µ—Ç–µ, –∫–æ—Ç–æ—Ä—ã–π –µ—Å—Ç—å –Ω–∞ —Å–∫–ª–∞–¥–µ
    if (!variant || variant.hidden) return;
    const size = Object.keys(variant.stocks).find(sz => variant.stocks[sz] > 0);
    this.selP.tempSize = size || null;
},
removePhoto(index) {
    // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–∞–º—è—Ç—å –±—Ä–∞—É–∑–µ—Ä–∞
    URL.revokeObjectURL(this.newP.localFiles[index].preview);
    this.newP.localFiles.splice(index, 1);
},
quickAddToCart(p) {
    if (!p) return;
    this.vib();

    // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –í–ò–î–ò–ú–´–ô –≤–∞—Ä–∏–∞–Ω—Ç
    const visibleVariants = this.getVisibleVariants(p);
    const activeIndex = this.getActiveColorIndex(p);
    const variant = visibleVariants[activeIndex];
    
    if (!variant) {
        return this.openProduct(p);
    }
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º variant –≤–º–µ—Å—Ç–æ p.variants[0]
    const currentStock = variant.stocks || variant.stock || {};

    // 2. –û–ü–†–ï–î–ï–õ–Ø–ï–ú –†–ê–ó–ú–ï–†
    // –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –∫–ª–∏–∫–Ω—É–ª –Ω–∞ —á–∏–ø –≤ –∫–∞—Ç–∞–ª–æ–≥–µ ‚Äî –±–µ—Ä–µ–º –µ–≥–æ (tempSize)
    // –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –∏—â–µ–º –ø–µ—Ä–≤—ã–π —Ä–∞–∑–º–µ—Ä, –≥–¥–µ –æ—Å—Ç–∞—Ç–æ–∫ > 0
    let selSize = p.tempSize;
    if (!selSize) {
        selSize = Object.keys(currentStock).find(sz => currentStock[sz] > 0);
    }

    // –ï—Å–ª–∏ —Ä–∞–∑–º–µ—Ä–æ–≤ –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏ ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Ç–æ–≤–∞—Ä–∞, —á—Ç–æ–±—ã –∫–ª–∏–µ–Ω—Ç —Å–∞–º –ø–æ—Å–º–æ—Ç—Ä–µ–ª
    if (!selSize || currentStock[selSize] <= 0) {
        return this.openProduct(p);
    }

    // 3. –ü–†–û–í–ï–†–ö–ê –°–ö–†–´–¢–´–• –†–ê–ó–ú–ï–†–û–í (–µ—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å —Ç–∞–∫–∞—è –ª–æ–≥–∏–∫–∞)
    if (p.hiddenSizes && p.hiddenSizes.includes(String(selSize))) {
        return; 
    }

    // 4. –§–û–†–ú–ò–†–£–ï–ú –£–ù–ò–ö–ê–õ–¨–ù–´–ô ID (ID —Ç–æ–≤–∞—Ä–∞ + –¶–≤–µ—Ç + –†–∞–∑–º–µ—Ä)
    const cartId = `${p.id}_${variant.color}_${selSize}`;
    
    // 5. –î–û–ë–ê–í–õ–ï–ù–ò–ï –í –ö–û–†–ó–ò–ù–£
    const exist = this.cart.find(i => i.cartId === cartId);
    
    if (exist) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ–º –ª–∏ –º—ã –æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ
        if (exist.qty < (currentStock[selSize] || 99)) {
            exist.qty++;
        } else {
            if (window.Telegram?.WebApp) {
                window.Telegram.WebApp.showAlert('–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –±–æ–ª—å—à–µ –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏');
            }
            return;
        }
    } else {
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω—É
        this.cart.push({ 
        id: p.id,
        cartId: cartId,
        title: p.title,
        price: Number(p.price),
        // –ë–µ—Ä–µ–º —Ñ–æ—Ç–æ –∏–∑ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –í–ò–î–ò–ú–û–ì–û –≤–∞—Ä–∏–∞–Ω—Ç–∞
        img: variant.images[0] || (p.images ? p.images[0] : ''),
        selSize: selSize,
        selColor: variant.color,
        qty: 1
    });
    }

    this.saveCart();
    
    // Telegram —Ñ–∏–¥–±–µ–∫
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
    }
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–ª–∞—à–∫–∏ "–î–æ–±–∞–≤–ª–µ–Ω–æ"
    this.showCartNotify = true;
    setTimeout(() => { this.showCartNotify = false; }, 2000);
},
      changeQty(item, delta) {
    // 1. –ù–∞—Ö–æ–¥–∏–º —Ç–æ–≤–∞—Ä –≤ –æ–±—â–µ–º —Å–ø–∏—Å–∫–µ products, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å–∫–ª–∞–¥
    const product = this.products.find(p => p.id === item.id);
    if (!product) return;

    // 2. –ù–∞—Ö–æ–¥–∏–º –Ω—É–∂–Ω—ã–π —Å–∫–ª–∞–¥ (stock) –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞
    const variant = product.variants.find(v => v.color === item.selColor);
    if (!variant) return;

    const maxStock = variant.stocks[item.selSize] || 0;

    if (delta > 0) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –µ—â–µ –º–µ—Å—Ç–æ –Ω–∞ —Å–∫–ª–∞–¥–µ
        if (item.qty < maxStock) {
            item.qty++;
            this.vib('light');
        } else {
            // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –º–∞–ª–µ–Ω—å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "–ë–æ–ª—å—à–µ –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏"
            if(window.Telegram?.WebApp) window.Telegram.WebApp.showAlert("–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —ç—Ç–æ –≤—Å—ë, —á—Ç–æ –µ—Å—Ç—å –≤ –Ω–∞–ª–∏—á–∏–∏");
        }
    } else {
        // –£–º–µ–Ω—å—à–∞–µ–º –∏–ª–∏ —É–¥–∞–ª—è–µ–º
        if (item.qty > 1) {
            item.qty--;
            this.vib('light');
        } else {
            this.removeFromCart(item.cartId);
        }
    }
    this.saveCart();
},

removeFromCart(cartId) {
    this.cart = this.cart.filter(i => i.cartId !== cartId);
    this.saveCart();
    this.vib('medium');
},

        saveCart() {
            localStorage.setItem('naran_cart_v3', JSON.stringify(this.cart));
        },

         setDelivery(d) {
    this.deliv = d;
    this.vib();
    // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π –∫–∞—Ä—Ç—ã
    setTimeout(() => {
        if (this.deliv && document.getElementById('map')) {
            this.initMap();
        }
    }, 100);
},

       // –ó–ê–ú–ï–ù–ò–¢–ï –º–µ—Ç–æ–¥ initMap() –Ω–∞ —ç—Ç–æ—Ç:
initMap() {
    // –ó–∞—â–∏—Ç–∞ –æ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–π
    if (this.mapInitializing) return;
    this.mapInitializing = true;
    
    try {
        if (this.map) { 
            this.map.destroy(); 
            this.map = null; 
        }
        
        const currentKey = 'a3fb6133-4bcf-46d3-9a05-c7d8b5812144';
        const mapContainer = document.getElementById('map');
        
        if (!mapContainer) {
            this.mapInitializing = false;
            return;
        }
        
        this.map = new mapgl.Map('map', {
            center: [37.6175, 55.7558],
            zoom: 13,
            key: currentKey
        });

        const setPos = (lat, lon) => {
            if (!this.map) return;
            this.map.setCenter([lon, lat]);
            this.map.setZoom(15);
            this.getAddress(lat, lon);
        };

        // –¢–û–õ–¨–ö–û –û–î–ò–ù –ò–°–¢–û–ß–ù–ò–ö –ì–ï–û–õ–û–ö–ê–¶–ò–ò
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (p) => setPos(p.coords.latitude, p.coords.longitude),
                (err) => console.log("–ì–µ–æ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è", err),
                { timeout: 5000, maximumAge: 60000 }
            );
        }

        // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–ª–∏–∫–∞
        this.map.on('click', (e) => {
            if (e.lngLat) {
                this.getAddress(e.lngLat[1], e.lngLat[0]);
            }
        });
        
    } catch (e) { 
        console.error("Map error", e); 
    } finally {
        setTimeout(() => { this.mapInitializing = false; }, 1000);
    }
},

      getAddress(lat, lon) {
    const currentKey = 'a3fb6133-4bcf-46d3-9a05-c7d8b5812144';
    // –î–æ–±–∞–≤–∏–ª–∏ –∑–∞–ø—Ä–æ—Å –≤—Å–µ—Ö –ø–æ–ª–µ–π, –≥–¥–µ –º–æ–∂–µ—Ç –ø—Ä—è—Ç–∞—Ç—å—Å—è –≥–æ—Ä–æ–¥
    const url = `https://catalog.api.2gis.com/3.0/items/geocode?lat=${lat}&lon=${lon}&radius=50&fields=items.adm_div,items.address,items.full_name&key=${currentKey}`;

    fetch(url)
        .then(r => r.json())
        .then(res => {
            if (res.result?.items?.length) {
                const item = res.result.items[0];
                let city = '';

                // 1. –ò—â–µ–º –≥–æ—Ä–æ–¥ –≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–º –¥–µ–ª–µ–Ω–∏–∏
                if (item.adm_div) {
                    const c = item.adm_div.find(d => ['city', 'settlement', 'district'].includes(d.type));
                    if (c) city = c.name;
                }

                // 2. –ï—Å–ª–∏ –ú–æ—Å–∫–≤–∞ –≤—Å—ë –µ—â–µ –Ω–µ –Ω–∞—à–ª–∞—Å—å, –±–µ—Ä–µ–º –µ—ë –∏–∑ full_name (—Ç–∞–º –≤—Å–µ–≥–¥–∞ –µ—Å—Ç—å –≥–æ—Ä–æ–¥)
                if (!city && item.full_name) {
                    // –†–∞–∑–±–∏–≤–∞–µ–º "–ú–æ—Å–∫–≤–∞, –ú–∞–Ω–µ–∂–Ω–∞—è –ø–ª–æ—â–∞–¥—å, 1" –∏ –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –∫—É—Å–æ–∫
                    city = item.full_name.split(',')[0].trim();
                }

                // 3. –ï—Å–ª–∏ –≥–æ—Ä–æ–¥ - —ç—Ç–æ –æ–∫—Ä—É–≥ –ú–æ—Å–∫–≤—ã (–Ω–∞–ø—Ä. –ó–µ–ª–µ–Ω–æ–≥—Ä–∞–¥), –ø—Ä–æ–≤–µ—Ä—è–µ–º —ç—Ç–æ
                const streetHouse = item.address_name || item.name;
                
                // –°–æ–±–∏—Ä–∞–µ–º –∞–¥—Ä–µ—Å. –ï—Å–ª–∏ –≥–æ—Ä–æ–¥ —É–∂–µ –µ—Å—Ç—å –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ —É–ª–∏—Ü—ã, –Ω–µ –¥—É–±–ª–∏—Ä—É–µ–º
                let cleanAddress = streetHouse;
                if (city && !streetHouse.toLowerCase().includes(city.toLowerCase())) {
                    cleanAddress = city + ', ' + streetHouse;
                }

                // –¢–í–û–Ø –õ–û–ì–ò–ö–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø (–ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô)
                const fullAddr = (this.deliv ? this.deliv + ': ' : '') + cleanAddress;
                
                this.address = fullAddr; 
                if (this.form) this.form.address = fullAddr; 
                localStorage.setItem('naran_last_addr', fullAddr); 
                
                this.$forceUpdate();
                
                if (window.Telegram?.WebApp?.HapticFeedback) {
                    window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
                }
            }
        })
        .catch(err => console.error("2GIS error", err));
},

        openSupport() { window.open('https://t.me/@optania', '_blank'); },
        
 
 async uploadToImgBB(file, fileObj) {
    return new Promise((resolve, reject) => {
        const imgbbKey = '4d4ab43d9b15c3dbadb9058518e4db23';
        
        // 1. –°–æ–∑–¥–∞–µ–º FormData
        const formData = new FormData();
        formData.append('image', file);
        
        // 2. –ò—Å–ø–æ–ª—å–∑—É–µ–º fetch —Å AbortController –¥–ª—è —Ç–∞–π–º–∞—É—Ç–∞
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
            controller.abort();
            reject(new Error('Timeout (15 seconds)'));
        }, 15000);
        
        // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
        fetch(`https://api.imgbb.com/1/upload?key=${imgbbKey}`, {
            method: 'POST',
            body: formData,
            signal: controller.signal
        })
        .then(async response => {
            clearTimeout(timeoutId);
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }
            
            const result = await response.json();
            
            if (result.success && result.data && result.data.url) {
                resolve(result.data.url);
            } else {
                throw new Error(result.error?.message || 'Unknown ImgBB error');
            }
        })
        .catch(error => {
            clearTimeout(timeoutId);
            reject(error);
        });
    });
},
async uploadFileToImgBB(file) {
    console.log(`=== –ó–ê–ì–†–£–ó–ö–ê –í IMGBB: ${file.name} ===`);
    console.log(`–†–∞–∑–º–µ—Ä: ${(file.size / 1024).toFixed(1)}KB, –¢–∏–ø: ${file.type}`);
    
    const imgbbKey = '4d4ab43d9b15c3dbadb9058518e4db23';
    
    // –°–Ω–∞—á–∞–ª–∞ —Å–∂–∏–º–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    const compressedFile = await this.compressImageFast(file);
    console.log(`–ü–æ—Å–ª–µ —Å–∂–∞—Ç–∏—è: ${compressedFile.size} –±–∞–π—Ç (${(compressedFile.size / 1024).toFixed(1)}KB)`);
    
    const formData = new FormData();
    formData.append('image', compressedFile);
    
    try {
        console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ ImgBB...');
        const response = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbKey}`, {
            method: 'POST',
            body: formData
        });
        
        console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status, response.statusText);
        const result = await response.json();
        
        // –í–ê–ñ–ù–û: –í—ã–≤–æ–¥–∏–º –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        console.log('=== –ü–û–õ–ù–´–ô –û–¢–í–ï–¢ IMGBB ===');
        console.log(JSON.stringify(result, null, 2));
        console.log('=========================');
        
        if (result.success) {
            // ImgBB –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç URL –≤ —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª—è—Ö
            console.log('–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–ª—è –≤ data:', Object.keys(result.data || {}));
            
            const imageUrl = result.data?.url || 
                            result.data?.display_url || 
                            result.data?.image?.url || 
                            (result.data?.thumb ? result.data.thumb.url : null) ||
                            (result.data?.medium ? result.data.medium.url : null);
            
            if (imageUrl) {
                console.log('‚úÖ –ù–∞–π–¥–µ–Ω URL:', imageUrl);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å URL
                if (!imageUrl.startsWith('http://') && !imageUrl.startsWith('https://')) {
                    console.warn('‚ö†Ô∏è URL –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å http/https, –∏—Å–ø—Ä–∞–≤–ª—è–µ–º...');
                    const correctedUrl = `https://${imageUrl}`;
                    console.log('–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π URL:', correctedUrl);
                    return correctedUrl;
                }
                
                return imageUrl;
            } else {
                console.error('‚ùå ImgBB –Ω–µ –≤–µ—Ä–Ω—É–ª URL. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:');
                console.log('- data.url:', result.data?.url);
                console.log('- data.display_url:', result.data?.display_url);
                console.log('- data.image:', result.data?.image);
                console.log('- data.thumb:', result.data?.thumb);
                throw new Error('ImgBB –Ω–µ –≤–µ—Ä–Ω—É–ª URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
            }
        } else {
            console.error('‚ùå ImgBB –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É:', result.error);
            throw new Error(result.error?.message || `ImgBB error: ${result.status}`);
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ ImgBB:', error);
        
        // Fallback –Ω–∞ Data URL
        if (compressedFile.size < 100 * 1024) {
            console.log('üîÑ –ò—Å–ø–æ–ª—å–∑—É—é Data URL –∫–∞–∫ fallback');
            return await this.fileToDataURL(compressedFile);
        }
        
        // –ï—Å–ª–∏ —Ñ–∞–π–ª –±–æ–ª—å—à–æ–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º placeholder
        console.log('üîÑ –ò—Å–ø–æ–ª—å–∑—É—é placeholder');
        return 'https://placehold.co/300x400/ffffff/000000?text=No+Image';
    }
},
// –ë—ã—Å—Ç—Ä–æ–µ —Å–∂–∞—Ç–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
compressImageFast(file) {
    return new Promise((resolve) => {
        // –ï—Å–ª–∏ —Ñ–∞–π–ª —É–∂–µ –º–∞–ª–µ–Ω—å–∫–∏–π (< 300KB), –Ω–µ —Å–∂–∏–º–∞–µ–º
        if (file.size < 300 * 1024) {
            resolve(file);
            return;
        }
        
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä
            const MAX_WIDTH = 800;
            const MAX_HEIGHT = 1000;
            let width = img.width;
            let height = img.height;
            
            if (width > MAX_WIDTH) {
                height = (height * MAX_WIDTH) / width;
                width = MAX_WIDTH;
            }
            if (height > MAX_HEIGHT) {
                width = (width * MAX_HEIGHT) / height;
                height = MAX_HEIGHT;
            }
            
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ JPEG —Å –∫–∞—á–µ—Å—Ç–≤–æ–º 75%
            canvas.toBlob((blob) => {
                const compressedFile = new File([blob], file.name, {
                    type: 'image/jpeg',
                    lastModified: Date.now()
                });
                resolve(compressedFile);
            }, 'image/jpeg', 0.75);
        };
        
        img.src = URL.createObjectURL(file);
    });
},
async saveProduct() {
    console.log('=== –ù–ê–ß–ê–õ–û –°–û–•–†–ê–ù–ï–ù–ò–Ø ===');
    
    // 1. –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!this.newP.title || !this.newP.price || !this.newP.category) {
        return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–Ω—É –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é!');
    }
    
    // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–≤–µ—Ç–æ–≤
    for (const variant of this.newP.variants) {
        if (!variant.color || variant.color.trim() === '') {
            return alert('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ü–≤–µ—Ç–∞ –¥–ª—è –≤—Å–µ—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤!');
        }
    }
    
    // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤
    let hasValidSizes = false;
    this.newP.variants.forEach(variant => {
        Object.values(variant.stocks || {}).forEach(qty => {
            if (qty > 0) hasValidSizes = true;
        });
    });
    
    if (!hasValidSizes) {
        return alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ä–∞–∑–º–µ—Ä —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –±–æ–ª—å—à–µ 0!');
    }
    
    this.loading = true;
    
    try {
        const finalVariants = [];
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Ü–≤–µ—Ç–∞
        for (let i = 0; i < this.newP.variants.length; i++) {
            const variant = this.newP.variants[i];
            
            // –ú–∞—Å—Å–∏–≤ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —ç—Ç–æ–≥–æ —Ü–≤–µ—Ç–∞
            let variantImages = [...(variant.images || [])];
            
            // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã –Ω–∞ ImgBB (–µ—Å–ª–∏ –µ—Å—Ç—å)
            if (variant.fileQueue && variant.fileQueue.length > 0) {
                console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ ${variant.fileQueue.length} —Ñ–∞–π–ª–æ–≤ –¥–ª—è —Ü–≤–µ—Ç–∞ "${variant.color}"`);
                const uploadedUrls = await this.uploadVariantFiles(i);
                variantImages.push(...uploadedUrls);
                
                // –û—á–∏—â–∞–µ–º –æ—á–µ—Ä–µ–¥—å –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                variant.fileQueue.forEach(fileObj => {
                    if (fileObj.preview && fileObj.preview.startsWith('blob:')) {
                        URL.revokeObjectURL(fileObj.preview);
                    }
                });
                variant.fileQueue = [];
            }
            
            // 2. –§–∏–ª—å—Ç—Ä—É–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ –≤–∞–ª–∏–¥–Ω—ã–µ URL
            const uniqueImages = [];
            const seenUrls = new Set();
            
            variantImages.forEach(img => {
                if (img && typeof img === 'string' && img.trim() !== '' && !seenUrls.has(img)) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –≤–∞–ª–∏–¥–Ω—ã–π URL
                    if (img.startsWith('http://') || img.startsWith('https://') || img.startsWith('data:image/')) {
                        uniqueImages.push(img.trim());
                        seenUrls.add(img);
                    }
                }
            });
            
            // 3. –ï—Å–ª–∏ –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
            if (uniqueImages.length === 0) {
                uniqueImages.push(this.defaultPlaceholder);
            }
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (–º–∞–∫—Å 5 –Ω–∞ —Ü–≤–µ—Ç)
            const finalImages = uniqueImages.slice(0, 5);
            
            // –°–æ–∑–¥–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
            finalVariants.push({
                color: variant.color.trim(),
                stocks: variant.stocks || {},
                images: finalImages // –§–æ—Ç–æ –¢–û–õ–¨–ö–û –¥–ª—è —ç—Ç–æ–≥–æ —Ü–≤–µ—Ç–∞!
            });
            
            console.log(`–¶–≤–µ—Ç "${variant.color}": ${finalImages.length} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π`);
        }
        
        // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        const productData = {
            title: this.newP.title.trim(),
            desc: (this.newP.desc || '').trim(),
            price: Number(this.newP.price),
            oldPrice: this.newP.oldPrice ? Number(this.newP.oldPrice) : null,
            category: this.newP.category,
            isNew: !!this.newP.isNew,
            hidden: !!this.newP.hidden,
            variants: finalVariants,
            updatedAt: Date.now()
        };
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
        const dataSize = new Blob([JSON.stringify(productData)]).size;
        console.log(`–†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö: ${(dataSize / 1024).toFixed(1)}KB`);
        
        if (dataSize > 900000) {
            alert(`‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–µ (${(dataSize / 1024 / 1024).toFixed(2)}MB).\n–£–º–µ–Ω—å—à–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.`);
            this.loading = false;
            return;
        }
        
        // –°–û–•–†–ê–ù–ï–ù–ò–ï –í FIRESTORE
        console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Firestore...');
        
        if (this.editId) {
            // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ç–æ–≤–∞—Ä–∞
            const docRef = window.fb.doc(window.db, "products", this.editId);
            await window.fb.updateDoc(docRef, productData);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
            const idx = this.products.findIndex(p => p.id === this.editId);
            if (idx !== -1) {
                const updatedProduct = { 
                    id: this.editId, 
                    ...productData,
                    aIdx: 0 
                };
                this.products.splice(idx, 1, updatedProduct);
                console.log('‚úÖ –¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ');
            }
            
            console.log('‚úÖ –¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω –≤ Firestore!');
            alert('‚úÖ –¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
            
        } else {
            // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
            productData.createdAt = Date.now();
            const docRef = await window.fb.addDoc(
                window.fb.collection(window.db, "products"), 
                productData
            );
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
            const newProduct = { 
                id: docRef.id, 
                ...productData,
                aIdx: 0 
            };
            this.products.unshift(newProduct);
            
            console.log('‚úÖ –¢–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω! ID:', docRef.id);
            alert('‚úÖ –¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
        }
        
        // –û–ß–ò–°–¢–ö–ê –ü–û–°–õ–ï –£–°–ü–ï–®–ù–û–ì–û –°–û–•–†–ê–ù–ï–ù–ò–Ø
        this.cleanupAfterSave();
        this.resetForm();
        this.tab = 'profile';
        
    } catch (error) {
        console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", error);
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
    } finally {
        this.loading = false;
        this.uploadState.isUploading = false;
    }
},
cleanupAfterSave() {
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–≤—å—é URL –¥–ª—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤
    const cleanupFileQueue = (variant) => {
        if (variant.fileQueue && Array.isArray(variant.fileQueue)) {
            variant.fileQueue.forEach(file => {
                if (file.preview && file.preview.startsWith('blob:')) {
                    URL.revokeObjectURL(file.preview);
                }
            });
            variant.fileQueue = [];
        }
    };
    
    // –û—á–∏—â–∞–µ–º —Ñ–∞–π–ª—ã –∏–∑ –≤—Å–µ—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
    this.newP.variants?.forEach(variant => {
        cleanupFileQueue(variant);
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞—Å—Å–∏–≤—ã –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        delete variant.localFiles;
        delete variant.uploadingFiles;
    });
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é
    this.newP = {
        title: '',
        desc: '',
        price: null,
        oldPrice: null,
        category: '',
        isNew: false,
        hidden: false,
        variants: [
            { 
                color: '', 
                images: [], 
                stocks: {},
                fileQueue: [] // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¢–û–õ–¨–ö–û fileQueue
            }
        ]
    };
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
    this.tempSizes = [[]];
    this.addSizeField(0);
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    this.editId = null;
    this.fullEditMode = false;
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
    this.uploadState = {
        isUploading: false,
        progress: 0,
        totalFiles: 0,
        uploadedFiles: 0,
        errors: []
    };
    
    console.log('–§–æ—Ä–º–∞ –æ—á–∏—â–µ–Ω–∞, –ø–∞–º—è—Ç—å –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∞');
},
// –ú–µ—Ç–æ–¥ haptic() –¥–ª—è –≤–∏–±—Ä–∞—Ü–∏–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ HTML)
haptic() {
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
    this.vib(); // –í—ã–∑—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥
},

// –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ compressImageForUpload (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
compressImageForUpload(file) {
    return this.compressImageFast(file); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥
},

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ favList (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ setTab)
updateFavListWithTempSize() {
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º
    this.favList.forEach(p => {
        if (p.variants && p.variants[0] && p.variants[0].stocks) {
            const firstVariant = p.variants[0];
            const availableSize = Object.keys(firstVariant.stocks)
                .find(sz => firstVariant.stocks[sz] > 0);
            p.tempSize = availableSize || null;
        }
    });
},

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è Data URL
fileToDataURL(file) {
    return new Promise((resolve, reject) => {
        // –°–Ω–∞—á–∞–ª–∞ —Å–∂–∏–º–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º Data URL
        this.compressImage(file).then(compressedFile => {
            const reader = new FileReader();
            reader.onload = (e) => {
                console.log(`Data URL —Å–æ–∑–¥–∞–Ω, —Ä–∞–∑–º–µ—Ä: ${(e.target.result.length / 1024).toFixed(1)}KB`);
                resolve(e.target.result);
            };
            reader.onerror = reject;
            reader.readAsDataURL(compressedFile);
        }).catch(error => {
            // –ï—Å–ª–∏ —Å–∂–∞—Ç–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∂–∞—Ç—å –¥–ª—è Data URL, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª');
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    });
},



async deleteProductWithConfirm(productId) {
    if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –Ω–∞–≤—Å–µ–≥–¥–∞ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä –∏–∑ –æ–±–ª–∞–∫–∞?")) {
        try {
            await window.fb.deleteDoc(window.fb.doc(window.db, "products", productId));
        } catch (e) {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏");
        }
    }
},

async manageCategory(action, id) {
    try {
        if (action === 'add' && this.newCat && this.newCat.trim()) {
            await window.fb.addDoc(window.fb.collection(window.db, "categories"), { 
                name: this.newCat.trim() 
            });
            this.newCat = '';
        } else if (action === 'del') {
            if(confirm("–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é?")) {
                await window.fb.deleteDoc(window.fb.doc(window.db, "categories", id));
            }
        }
    } catch (e) {
        alert("–û—à–∏–±–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: " + e.message);
    }
},

// –ú–µ—Ç–æ–¥ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–í –ø—É—Ç–∏" –∏ "–ì–æ—Ç–æ–≤"
async checkout() {
    this.vib();
    
    if (!this.form.name || !this.form.phone || !this.address) {
        return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω –∏ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏!");
    }
    if (this.cart.length === 0) return alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!");

    this.loading = true;
    
    try {
        const tgUser = window.Telegram.WebApp?.initDataUnsafe?.user;
        const username = tgUser?.username ? `@${tgUser.username}` : '–Ω–µ—Ç –Ω–∏–∫–∞';

        // --- –ì–ï–ù–ï–†–ê–¶–ò–Ø –ù–û–í–û–ì–û –§–û–†–ú–ê–¢–ê –ù–û–ú–ï–†–ê (–î–î–ú–ú-–†–∞–Ω–¥–æ–º) ---
        const now = new Date();
        const day = String(now.getDate()).padStart(2, '0');
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const randomDigits = Math.floor(1000 + Math.random() * 9000); // 4 —Å–ª—É—á–∞–π–Ω—ã–µ —Ü–∏—Ñ—Ä—ã
        const newOrderId = `${day}${month}-${randomDigits}`; 
        // ----------------------------------------------------

        // –°–ù–ò–ñ–ï–ù–ò–ï –û–°–¢–ê–¢–ö–û–í
        for (let item of this.cart) {
            const pRef = window.fb.doc(window.db, "products", item.id);
            const pSnap = await window.fb.getDoc(pRef);
            if (pSnap.exists()) {
                let d = pSnap.data();
                const sz = String(item.selSize || item.size);
                const qty = Number(item.qty || 1);
                if (d.variants && d.variants.length > 0) {
                    let vds = [...d.variants];
                    let vIdx = vds.findIndex(v => v.color === (item.selColor || item.color));
                    if (vIdx > -1) {
                        let targetVariant = vds[vIdx];
                        let currentStocks = targetVariant.stocks || targetVariant.stock || {};
                        if (currentStocks[sz] !== undefined) {
                            currentStocks[sz] = Math.max(0, Number(currentStocks[sz]) - qty);
                            await window.fb.updateDoc(pRef, { variants: vds });
                        }
                    }
                } 
            }
        }

        const finalTotal = this.total(); 

       const orderData = {
        order_id: newOrderId,
        customer_name: this.form.name,
        customer_phone: this.form.phone,
        address: this.address,
        items: this.cart.map(i => ({
            id: i.id,
            title: i.title,
            count: i.qty || 1,
            color: i.selColor || i.color || '-',
            size: i.selSize || i.size || '-',
            price: i.price
        })),
        order_total: finalTotal, 
        status: '–ù–æ–≤—ã–π',
        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –í–ê–†–ò–ê–ù–¢: serverTimestamp –Ω—É–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –∫–∞–∫ —Ñ—É–Ω–∫—Ü–∏—é
        createdAt: window.fb.serverTimestamp(), // ‚Üê –í–´–ó–í–ê–¢–¨ –§–£–ù–ö–¶–ò–Æ!
        user: {
            id: tgUser?.id || 0,
            username: username
        }
    };

        await window.fb.addDoc(window.fb.collection(window.db, "orders"), orderData);
        
        // –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –ê–î–ú–ò–ù–ê
        const botToken = '8546116032:AAEeKb3J5o-revyZs7KhTV-VoO609tRV0Ek';
        const adminId = 387881523; 
        let itemsText = orderData.items.map(i => `‚Ä¢ ${i.title} (${i.color}, ${i.size}) x${i.count}`).join('\n');
        
        let adminMsg = `üõç *–ù–û–í–´–ô –ó–ê–ö–ê–ó ‚Ññ${orderData.order_id}*\n` +
                       `üë§ –ö–ª–∏–µ–Ω—Ç: ${orderData.customer_name} (${username})\n` +
                       `üìû –¢–µ–ª: ${orderData.customer_phone}\n` +
                       `üìç –ê–¥—Ä–µ—Å: ${orderData.address}\n\n` +
                       `üìã –°–æ—Å—Ç–∞–≤:\n${itemsText}\n\n` +
                       `üí∞ –ò—Ç–æ–≥–æ: *${finalTotal} ‚ÇΩ*`;

        await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chat_id: adminId, text: adminMsg, parse_mode: 'Markdown' })
        }).catch(e => console.error("–û—à–∏–±–∫–∞:", e));

        alert(`–ó–∞–∫–∞–∑ #${orderData.order_id} –æ—Ñ–æ—Ä–º–ª–µ–Ω!`);
        
        this.cart = [];
        this.saveCart();
        this.tab = 'catalog'; 
        
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞:", e);
        alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: " + e.message);
    } finally {
        this.loading = false;
    }
},
closeProductModal() {
    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É
    document.body.style.overflow = '';
    
    // –í–∏–±—Ä–∞—Ü–∏—è
    if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
    
    // –û—á–∏—â–∞–µ–º —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –º–µ—Ä—Ü–∞–Ω–∏—è
    setTimeout(() => {
        this.selP = null;
        this.currentVariantIndex = 0;
        this.openedProduct = null;
        this.selVariantIdx = 0;
    }, 50);
},
async updateStatus(order, newStatus) {
    if (order.status === newStatus) return;

    try {
        order.isUpdating = true;
        const orderRef = window.fb.doc(window.db, "orders", order.id);
        await window.fb.updateDoc(orderRef, { status: newStatus });
        
        // --- –ë–õ–û–ö –£–í–ï–î–û–ú–õ–ï–ù–ò–ô ---
        const botToken = '8546116032:AAEeKb3J5o-revyZs7KhTV-VoO609tRV0Ek';
        
        // –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ç–µ—Ö, –∫—Ç–æ –ø–æ–ª—É—á–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
        const recipients = [];
        
        // 1. –î–æ–±–∞–≤–ª—è–µ–º ID –∫–ª–∏–µ–Ω—Ç–∞
        const customerId = order.user_id || (order.user ? order.user.id : null);
        if (customerId) recipients.push(customerId);
        
        // 2. –î–æ–±–∞–≤–ª—è–µ–º —Ç–≤–æ–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ ID (–∞–¥–º–∏–Ω—ã, –º–µ–Ω–µ–¥–∂–µ—Ä—ã)
        const extraIds = [387881523]; // –ó–ê–ú–ï–ù–ò –≠–¢–ò –¶–ò–§–†–´ –ù–ê –ù–£–ñ–ù–´–ï ID
        extraIds.forEach(id => {
            if (!recipients.includes(id)) recipients.push(id);
        });

        let message = "";
        if (newStatus === '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω') {
            message = `üöÄ *–ó–∞–∫–∞–∑ ‚Ññ${order.order_id} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!*\n\nüì¶ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞: ${newStatus}`;
        } else if (newStatus === '–î–æ—Å—Ç–∞–≤–ª–µ–Ω') {
            message = `‚úÖ *–ó–∞–∫–∞–∑ ‚Ññ${order.order_id} –¥–æ—Å—Ç–∞–≤–ª–µ–Ω!*\n\n–°—Ç–∞—Ç—É—Å: ${newStatus}`;
        }

        if (message && recipients.length > 0) {
            // –†–∞—Å—Å—ã–ª–∞–µ–º –≤—Å–µ–º –∏–∑ —Å–ø–∏—Å–∫–∞ recipients
            for (const targetId of recipients) {
                try {
                    await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chat_id: targetId,
                            text: message,
                            parse_mode: 'Markdown'
                        })
                    });
                    console.log(`–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ ID: ${targetId}`);
                } catch (err) {
                    console.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–ª—è ${targetId}:`, err);
                }
            }
        }
        // --- –ö–û–ù–ï–¶ –ë–õ–û–ö–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–ô ---

        if (window.Telegram.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');

    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:", e);
        alert("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å –±–∞–∑–æ–π.");
    } finally {
        order.isUpdating = false;
    }
},

calculateListHeight() {
    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π: —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ —Å–ø–∏—Å–æ–∫ –æ—Ç–∫—Ä—ã—Ç –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –∞–¥–º–∏–Ω
    if (this.showProductList && this.isAdmin) {
        // 2. –ñ–¥–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è DOM
        this.$nextTick(() => {
            // 3. –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤ DOM
            const adminSection = document.querySelector('.admin-section'); // –í—Å—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
            const listHeader = document.querySelector('[style*="–°–ü–ò–°–û–ö –¢–û–í–ê–†–û–í"]'); // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–ø–∏—Å–∫–∞
            const listContainer = document.querySelector('.stable-scroll-container'); // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–ø–∏—Å–∫–∞
            
            // 4. –ï—Å–ª–∏ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã
            if (adminSection && listHeader && listContainer) {
                // 5. –í—ã—á–∏—Å–ª—è–µ–º –≤—ã—Å–æ—Ç—É –∑–∞–≥–æ–ª–æ–≤–∫–∞
                const headerHeight = listHeader.offsetHeight;
                
                // 6. –í—ã—á–∏—Å–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—É—é –≤—ã—Å–æ—Ç—É:
                //    window.innerHeight - –æ–±—â–∞—è –≤—ã—Å–æ—Ç–∞ –æ–∫–Ω–∞
                //    adminSection.getBoundingClientRect().top - —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –≤–µ—Ä—Ö–∞ –æ–∫–Ω–∞ –¥–æ –∞–¥–º–∏–Ω-—Å–µ–∫—Ü–∏–∏
                //    headerHeight - –≤—ã—Å–æ—Ç–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞
                //    -40 - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã (padding/margin)
                const availableHeight = window.innerHeight - adminSection.getBoundingClientRect().top - headerHeight - 40;
                
                // 7. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–º–∏–Ω–∏–º—É–º 300px)
                listContainer.style.height = Math.max(300, availableHeight) + 'px';
            }
        });
    }
},

async deleteOrder(docId) {
    const confirmText = "‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑ –Ω–∞–≤—Å–µ–≥–¥–∞?";
    
    const proceedDelete = async () => {
        try {
            await window.fb.deleteDoc(window.fb.doc(window.db, "orders", docId));
            if (window.Telegram.WebApp && window.Telegram.WebApp.version && parseFloat(window.Telegram.WebApp.version) >= 6.1) {
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }
        } catch (e) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å: " + e.message);
        }
    };

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–ü–ö + –¢–ì)
    if (window.Telegram.WebApp && window.Telegram.WebApp.showConfirm && parseFloat(window.Telegram.WebApp.version) >= 6.2) {
        window.Telegram.WebApp.showConfirm(confirmText, (yes) => { if (yes) proceedDelete(); });
    } else {
        if (confirm(confirmText)) proceedDelete();
    }
},
       printOrder(o) {
    try {
        if (this.vib) this.vib(); 
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
        const date = o.createdAt ? (o.createdAt.seconds ? new Date(o.createdAt.seconds * 1000).toLocaleString('ru-RU') : new Date(o.createdAt).toLocaleString('ru-RU')) : '---';
        
        // –ù–∏–∫ –∫–ª–∏–µ–Ω—Ç–∞ (–∏–∑ –æ–±—ä–µ–∫—Ç–∞ user)
        const username = o.user && o.user.username ? `(${o.user.username})` : '';

        // 1. –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
        const itemsList = o.items || []; 
        let itemsHtml = '';

        if (Array.isArray(itemsList) && itemsList.length > 0) {
            itemsHtml = itemsList.map(i => `
                <tr style="border-bottom: 2px solid #f0f0f0;">
                    <td style="padding: 20px 0;">
                        <div style="font-weight: 800; font-size: 20px; text-transform: uppercase; margin-bottom: 10px;">
                            ${i.title || '–¢–æ–≤–∞—Ä –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}
                        </div>
                        <div style="display: flex; gap: 30px; font-size: 14px; color: #333;">
                            <span><b>–¶–≤–µ—Ç:</b> ${i.color || i.selColor || '-'}</span>
                            <span><b>–†–∞–∑–º–µ—Ä:</b> ${i.size || i.selSize || '-'}</span>
                            <span><b>–ö–æ–ª-–≤–æ:</b> ${i.count || i.qty || 1} —à—Ç.</span>
                            <span><b>–¶–µ–Ω–∞ –∑–∞ –µ–¥.:</b> ${i.price || 0} ‚ÇΩ</span>
                        </div>
                    </td>
                    <td style="padding: 20px 0; text-align: right; vertical-align: middle;">
                        <div style="font-weight: 800; font-size: 20px;">
                            ${(i.price || 0) * (i.count || i.qty || 1)} ‚ÇΩ
                        </div>
                    </td>
                </tr>
            `).join('');

           
        } else {
            itemsHtml = `<tr><td colspan="2" style="padding: 40px 0; font-size: 16px;">${o.items_text || '–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –ø—É—Å—Ç'}</td></tr>`;
        }

        const win = window.open('', '_blank');
        if (!win) return alert("–†–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞.");

        win.document.write(`
            <html>
            <head>
                <title>–ó–∞–∫–∞–∑ #${o.order_id}</title>
                <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&display=swap" rel="stylesheet">
                <style>
                    @page { size: A4 portrait; margin: 15mm; }
                    body { font-family: 'Montserrat', sans-serif; margin: 0; padding: 0; color: #000; background: #fff; }
                    .wrapper { width: 100%; max-width: 210mm; margin: auto; }
                    .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 40px; border-bottom: 4px solid #000; padding-bottom: 20px; }
                    .brand h1 { margin: 0; font-size: 35px; font-weight: 800; letter-spacing: -1px; line-height: 1; }
                    .brand p { margin: 5px 0 0 0; color: #888; font-weight: 700; font-size: 12px; text-transform: uppercase; }
                    .order-info { text-align: right; }
                    .order-info h2 { margin: 0; font-size: 24px; font-weight: 800; }
                    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 30px; }
                    .address-box { border: 2px solid #000; padding: 20px; margin-bottom: 30px; }
                    table { width: 100%; border-collapse: collapse; }
                    th { text-align: left; text-transform: uppercase; font-size: 12px; color: #888; border-bottom: 1px solid #000; padding-bottom: 10px; font-weight: 700; }
                    .total-section { margin-top: 50px; text-align: right; border-top: 4px solid #000; padding-top: 20px; }
                    .total-section h2 { margin: 0; font-size: 45px; font-weight: 800; line-height: 1; }
                </style>
            </head>
            <body>
                <div class="wrapper">
                    <div class="header">
                        <div class="brand"><h1>NARAN</h1><p>–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —á–µ–∫ –∑–∞–∫–∞–∑–∞</p></div>
                        <div class="order-info"><h2>–ó–ê–ö–ê–ó #${o.order_id}</h2><p>–î–∞—Ç–∞: ${date}</p></div>
                    </div>
                    <div class="info-grid">
                        <div>
                            <small style="color:#888; font-weight:700; text-transform: uppercase; font-size: 10px;">–ü–æ–∫—É–ø–∞—Ç–µ–ª—å</small>
                            <p style="font-size: 18px; font-weight: 700; margin: 5px 0;">${o.customer_name || '–ù–µ —É–∫–∞–∑–∞–Ω'} ${username}</p>
                            <p style="margin: 0; font-weight: 400;">${o.customer_phone || '---'}</p>
                        </div>
                       
                    </div>
                    <div class="address-box">
                        <small style="color:#888; font-weight:700; text-transform: uppercase; font-size: 10px;">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏:</small>
                        <p style="font-size: 22px; font-weight: 800; margin: 10px 0 0 0;">${o.address || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –∏ —É—Å–ª—É–≥</th>
                                <th style="text-align: right;">–°—É–º–º–∞</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                    </table>
                    <div class="total-section">
                        <div style="font-weight: 700; color: #888; font-size: 14px; margin-bottom: 5px;">–ò–¢–û–ì–û –ö –û–ü–õ–ê–¢–ï</div>
                        <h2>${o.order_total || 0} ‚ÇΩ</h2>
                    </div>
                </div>
                <script>
                    window.onload = function() { 
                        window.print(); 
                        setTimeout(() => { window.close(); }, 700); 
                    };
                <\/script>
            </body>
            </html>
        `);
        win.document.close();
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏:", e);
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —á–µ–∫–∞.");
    }
},
cleanupAllPreviews() {
        // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö preview URL
        const cleanupArray = (arr) => {
            if (!arr || !Array.isArray(arr)) return;
            arr.forEach(item => {
                if (item.preview && item.preview.startsWith('blob:')) {
                    URL.revokeObjectURL(item.preview);
                }
            });
        };
        
        // –û—á–∏—Å—Ç–∫–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
        this.newP.variants?.forEach(variant => {
            cleanupArray(variant.localFiles);
            cleanupArray(variant.uploadingFiles);
        });
        
        // –û—á–∏—Å—Ç–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –º–∞—Å—Å–∏–≤–æ–≤
        cleanupArray(this.editNewFiles);
        cleanupArray(this.localFiles);
        cleanupArray(this.uploadFiles);
    },
updateChart() {
    console.log('=== updateChart() called ===');
    console.log('Current tab:', this.tab);
    console.log('isAdmin:', this.isAdmin);
    console.log('allOrders count:', this.allOrders?.length);
    
    const ctx = document.getElementById('orderChart');
    console.log('Canvas element found:', !!ctx);
    
    if (!ctx) {
        console.warn('Canvas not found! Returning...');
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Chart.js
    if (typeof Chart === 'undefined') {
        console.error('Chart.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!');
        return;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
    const orders = this.allOrders || [];
    const labels = [];
    const counts = [];
    const now = new Date();

    console.log('Processing orders for chart...');
    
    // –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
    for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(now.getDate() - i);
        const label = d.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
        labels.push(label);
        
        const dayStart = new Date(d);
        dayStart.setHours(0, 0, 0, 0);
        const dayEnd = new Date(d);
        dayEnd.setHours(23, 59, 59, 999);
        
        const dayStartTime = dayStart.getTime();
        const dayEndTime = dayEnd.getTime();
        
        const dayOrders = orders.filter(o => {
            let orderTime = 0;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã createdAt
            if (o.createdAt?.seconds) {
                // Firebase Timestamp
                orderTime = o.createdAt.seconds * 1000;
            } else if (typeof o.createdAt === 'number') {
                // Unix timestamp
                orderTime = o.createdAt;
            } else if (o.createdAt?.toDate) {
                // Firebase Timestamp –º–µ—Ç–æ–¥–æ–º toDate()
                orderTime = o.createdAt.toDate().getTime();
            } else if (o.date) {
                // –°—Ç—Ä–æ–∫–æ–≤–∞—è –¥–∞—Ç–∞
                orderTime = new Date(o.date).getTime();
            }
            
            return orderTime >= dayStartTime && orderTime <= dayEndTime;
        });
        
        counts.push(dayOrders.length);
        console.log(`–î–µ–Ω—å ${label}: ${dayOrders.length} –∑–∞–∫–∞–∑–æ–≤`);
    }

    console.log('Labels:', labels);
    console.log('Counts:', counts);

    // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—Ç–∞—Ä—ã–π –≥—Ä–∞—Ñ–∏–∫ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ
    if (this.chart && typeof this.chart.destroy === 'function') {
        console.log('Destroying old chart...');
        this.chart.destroy();
    }

    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫
    try {
        console.log('Creating new chart...');
        this.chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '–ó–∞–∫–∞–∑—ã',
                    data: counts,
                    borderColor: '#000',
                    backgroundColor: 'rgba(0,0,0,0.05)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 5,
                    pointBackgroundColor: '#000',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { 
                    duration: 800,
                    easing: 'easeInOutQuart'
                },
                plugins: { 
                    legend: { 
                        display: false 
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: '#000',
                        borderWidth: 1
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        grid: { 
                            display: true,
                            color: 'rgba(0,0,0,0.05)'
                        }, 
                        ticks: { 
                            stepSize: 1,
                            font: {
                                family: 'Montserrat',
                                weight: '600'
                            }
                        },
                        title: {
                            display: false
                        }
                    },
                    x: { 
                        grid: { 
                            display: true,
                            color: 'rgba(0,0,0,0.05)'
                        },
                        ticks: {
                            maxRotation: 0,
                            font: {
                                family: 'Montserrat',
                                weight: '600'
                            }
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
        
        console.log('Chart created successfully!');
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –Ω–∞ —Ä–µ—Å–∞–π–∑ –æ–∫–Ω–∞ –¥–ª—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞
        window.addEventListener('resize', () => {
            if (this.chart) {
                this.chart.resize();
            }
        });
        
    } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞:", err);
        console.error("Error details:", err.message);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –Ω–∞ canvas
        ctx.style.display = 'flex';
        ctx.style.alignItems = 'center';
        ctx.style.justifyContent = 'center';
        ctx.style.color = '#ff3b30';
        ctx.style.fontSize = '12px';
        ctx.style.fontWeight = '600';
        ctx.innerHTML = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞: ' + err.message;
    }
}
    },
 mounted() {
    window.addEventListener('beforeunload', () => {
        this.cleanupAllPreviews();
    });
    const tg = window.Telegram.WebApp || {};
     console.log('ImgBB Key:', '4d4ab43d9b15c3dbadb9058518e4db23');
    // 1. –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram
    if (window.Telegram?.WebApp) {
        try {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            console.log('Telegram WebApp initialized');
        } catch (e) {
            console.warn("Telegram WebApp error:", e);
        }
    }
    
    // 2. –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å fallback
    this.user = window.Telegram?.WebApp?.initDataUnsafe?.user || { 
        id: 387881523, 
        first_name: 'Admin_Test' 
    };
    
    console.log('User:', this.user);
    
    // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω–∞
    this.isAdmin = this.adminIds.includes(Number(this.user.id));
    console.log('Is admin:', this.isAdmin);
    
    // 4. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ localStorage
    const savedAddr = localStorage.getItem('naran_last_addr');
    if (savedAddr) this.address = savedAddr;
    
    this.$watch(() => this.products, () => {
        // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –æ—á–∏—â–∞–µ–º –∫—ç—à –≤—ã–±–æ—Ä–∞ —Ü–≤–µ—Ç–æ–≤
        this.catalogActiveColors = {};
    }, { deep: true });
    
    // 5. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
    let firebaseInitAttempts = 0;
    const MAX_ATTEMPTS = 10;
    
    const initFirebaseData = () => {
        if (firebaseInitAttempts >= MAX_ATTEMPTS) {
            console.error("Failed to initialize Firebase after", MAX_ATTEMPTS, "attempts");
            return;
        }
        
        firebaseInitAttempts++;
        
        if (window.db && window.fb && window.fb.onSnapshot) {
            console.log("Firebase initialized, attempt", firebaseInitAttempts);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–ø–∏—Å–∫–∏ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏
            this.unsubscribers = [];
            
            // 5.1. –¢–æ–≤–∞—Ä—ã
            const unsubProducts = window.fb.onSnapshot(
                window.fb.query(
                    window.fb.collection(window.db, "products"), 
                    window.fb.orderBy("createdAt", "desc")
                ), 
                snap => {
                    this.products = snap.docs.map(doc => ({ 
                        id: doc.id, 
                        ...doc.data(), 
                        aIdx: 0 
                    }));
                    console.log('Products loaded:', this.products.length);
                    
                    this.$nextTick(() => {
                        if (this.tab === 'profile') {
                            this.calculateListHeight();
                        }
                    });
                },
                err => console.error("Products error:", err)
            );
            this.unsubscribers.push(unsubProducts);
            
            // 5.2. –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
            const unsubCategories = window.fb.onSnapshot(
                window.fb.collection(window.db, "categories"), 
                snap => {
                    this.categories = snap.docs.map(doc => ({ 
                        id: doc.id, 
                        ...doc.data() 
                    }));
                    console.log('Categories loaded:', this.categories.length);
                },
                err => console.error("Categories error:", err)
            );
            this.unsubscribers.push(unsubCategories);
            
            // 5.3. –ó–ê–ö–ê–ó–´ (–í–ê–ñ–ù–û - –î–û–ë–ê–í–õ–Ø–ï–ú –≠–¢–û–¢ –°–õ–£–®–ê–¢–ï–õ–¨!)
            const unsubOrders = window.fb.onSnapshot(
                window.fb.query(
                    window.fb.collection(window.db, "orders"),
                    window.fb.orderBy("createdAt", "desc")
                ),
                snap => {
                    this.allOrders = snap.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
                            displayDate: data.createdAt?.toDate 
                                ? data.createdAt.toDate().toLocaleDateString('ru-RU')
                                : new Date().toLocaleDateString('ru-RU')
                        };
                    });
                    console.log('Orders loaded:', this.allOrders.length);
                    console.log('Sample order:', this.allOrders[0]);
                    
                    // –ï—Å–ª–∏ –º—ã –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –ø—Ä–æ—Ñ–∏–ª—è –∏ –∞–¥–º–∏–Ω - –æ–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫
                    if (this.tab === 'profile' && this.isAdmin) {
                        this.$nextTick(() => {
                            setTimeout(() => {
                                console.log('Auto-updating chart after orders load...');
                                this.updateChart();
                            }, 800);
                        });
                    }
                },
                err => {
                    console.error("Orders error:", err);
                    // –ï—Å–ª–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ orders –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
                    this.allOrders = [];
                }
            );
            this.unsubscribers.push(unsubOrders);
            
        } else {
            console.log("Waiting for Firebase... attempt", firebaseInitAttempts);
            setTimeout(initFirebaseData, 300);
        }
    };
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é Firebase
    initFirebaseData();
    
    // 6. –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    this.resizeHandler = () => {
        this.calculateListHeight();
        // –ü—Ä–∏ —Ä–µ—Å–∞–π–∑–µ –æ–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        if (this.tab === 'profile' && this.isAdmin && this.chart) {
            setTimeout(() => {
                if (this.chart) {
                    this.chart.resize();
                }
            }, 100);
        }
    };
    window.addEventListener('resize', this.resizeHandler);
},


beforeDestroy() {
    // 1. –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç Firebase —Å–ª—É—à–∞—Ç–µ–ª–µ–π
    if (this.unsubscribers) {
        this.unsubscribers.forEach(unsub => {
            try {
                if (typeof unsub === 'function') unsub();
            } catch (e) {
                console.error("Error unsubscribing:", e);
            }
        });
    }
    
    // 2. –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
    if (this.chart && typeof this.chart.destroy === 'function') {
        this.chart.destroy();
    }
    
    // 3. –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    if (this.resizeHandler) {
        window.removeEventListener('resize', this.resizeHandler);
    }
    
    // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–µ—Å–∞–π–∑–∞ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
    window.removeEventListener('resize', () => {
        if (this.chart) {
            this.chart.resize();
        }
    });
}

}).mount('#app');
</script>

</body>
</html>
